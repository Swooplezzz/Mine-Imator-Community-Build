/*
	NOTE:
	This file was autogenerated by CppGen, changes may be overwritten and forever lost!
	Modify at your own risk!
	
	[ Generated on 2023.12.21 19:05:35 ]
*/

#include "Scripts.hpp"

namespace CppProject
{
	BoolType textbox_draw(ScopeAny self, VarType tbx, VarType xx, VarType yy, VarType w, VarType h, BoolType contextmenu, BoolType right)
	{
		BoolType changetext, mouseover;
		RealType deletetext, lineheight;
		VarType inserttext;
		VarType a, b, l, ww, str, textx;
		StringType c;
		RealType p, hh;
		IntType k;
		RealType prevalpha, textnormala, textsuffixa, texthighlighta;
		VarType textnormal, textsuffix, highlight;
		IntType texthighlight;
		prevalpha = draw_get_alpha();
		textnormal = global::c_text_main;
		textnormala = global::a_text_main * prevalpha;
		textsuffix = global::c_text_tertiary;
		textsuffixa = global::a_text_tertiary;
		highlight = global::c_accent;
		texthighlight = global::c_button_text;
		texthighlighta = global::a_button_text * prevalpha;
		if (idVar(tbx, last_text) != idVar(tbx, text))
		{
			str = idVar(tbx, text);
			str = string_replace_all(str, /*"\r\n"*/ STR(3868), /*"\n"*/ STR(76));
			if (idInt(tbx, max_chars) > IntType(0))
				str = string_copy(str, IntType(1), idInt(tbx, max_chars));
			if (idReal(tbx, single_line) > 0)
				str = string_replace_all(str, /*"\n"*/ STR(76), /*" "*/ STR(21));
			idVar(tbx, text) = str;
			str += /*"\n"*/ STR(76);
			idVar(tbx, lines) = IntType(0);
			while (str != /*""*/ STR(0))
			{
				idArr(tbx, line)[idVar(tbx, lines)] = string_copy(str, IntType(1), (IntType)(string_pos(/*"\n"*/ STR(76), str) - IntType(1)));
				idArr(tbx, line_wrap)[idVar(tbx, lines)] = IntType(0);
				idArr(tbx, line_single)[idVar(tbx, lines)] = IntType(0);
				idVar(tbx, lines)++;
				str = string_delete(str, IntType(1), string_pos(/*"\n"*/ STR(76), str));
			}
			
			changetext = true;
		}
		else
			changetext = false;
		
		deletetext = IntType(0);
		inserttext = /*""*/ STR(0);
		lineheight = string_height(/*" "*/ STR(21));
		mouseover = (sBool(content_mouseon) && app_mouse_box(self, xx, yy, w, h));
		if (!sBool(mouse_left) && ((sVar(window_busy) == string(tbx) + /*"tbxrelease"*/ STR(3869)) || (sVar(window_busy) == string(tbx) + /*"click"*/ STR(1100))))
			sVar(window_busy) = /*""*/ STR(0);
		if (sVar(window_focus) == string(tbx))
		{
			if (contextmenu)
				context_menu_area(self, { xx, yy, w, h, /*"contextmenutextbox"*/ STR(1102), tbx, e_context_type_NONE, null_, null_ });
			ArrType keys, key_press;
			RealType action;
			sBool(textbox_isediting) = true;
			sBool(textbox_isediting_respond) = true;
			if (sVar(textbox_lastfocus) != tbx)
			{
				sVar(textbox_select_endline) = idVar(tbx, lines) - IntType(1);
				sVar(textbox_select_endpos) = string_length(idArr(tbx, line).Value(sVar(textbox_select_endline)));
				if (idReal(tbx, select_on_focus) > 0)
				{
					sVar(textbox_select_startline) = IntType(0);
					sVar(textbox_select_startpos) = IntType(0);
				}
				else
				{
					sVar(textbox_select_startline) = sVar(textbox_select_endline);
					sVar(textbox_select_startpos) = sVar(textbox_select_endpos);
				}
				
				sVar(textbox_select_mouseline) = sVar(textbox_select_endline);
				sVar(textbox_select_mousepos) = sVar(textbox_select_endpos);
				sVar(textbox_select_clickline) = IntType(0);
				sVar(textbox_select_clickpos) = IntType(0);
			}
			keys = ArrType::From({ vk_enter, vk_backspace, vk_delete, (IntType)'V', vk_right, vk_left, vk_up, vk_down });
			for (k = IntType(0); k < array_length(VarType::CreateRef(keys)); k++)
			{
				key_press[keys.Value(k)] = false;
				if (keyboard_check(keys.Value(k)))
				{
					if (current_time() - sArr(textbox_key_delay).Value(k) > IntType(30))
					{
						key_press[keys.Value(k)] = true;
						sArr(textbox_key_delay)[k] = current_time() + IntType(500) * (IntType)keyboard_check_pressed(keys.Value(k));
					}
				}
				else
					sArr(textbox_key_delay)[k] = IntType(0);
				
			}
			if (!mouseover && (sBool(mouse_left_pressed) && !keyboard_check(vk_shift) && !sBool(context_menu_mouseon)) || (idReal(tbx, single_line) > 0 && keyboard_check_pressed(vk_enter)))
				sVar(window_focus) = /*""*/ STR(0);
			if (!(idReal(tbx, read_only) > 0) && sVar(window_busy) == /*""*/ STR(0) && !keyboard_check(vk_control))
			{
				deletetext = key_press.Value(vk_backspace) - key_press.Value(vk_delete);
				inserttext = sStr(textbox_input);
			}
			if (!(idReal(tbx, single_line) > 0))
			{
				idVar(tbx, start) += mouse_wheel_down() - mouse_wheel_up();
				if (key_press.Value(vk_enter) && !(idReal(tbx, read_only) > 0))
					inserttext = /*"\n"*/ STR(76);
			}
			if (key_press.Value(vk_right) || key_press.Value(vk_left) || (key_press.Value(vk_up) && sVar(textbox_select_mouseline) > IntType(0)) || (key_press.Value(vk_down) && sVar(textbox_select_mouseline) < idVar(tbx, lines) - IntType(1)))
			{
				if (key_press.Value(vk_right) || key_press.Value(vk_left))
				{
					if (keyboard_check(vk_control))
					{
						if (key_press.Value(vk_right))
						{
							StringType char_ = string_char_at(idVar(tbx, text), (IntType)(sVar(textbox_select_mousepos) + IntType(1)));
							if (char_ == /*" "*/ STR(21) || char_ == /*"\n"*/ STR(76))
							{
								sVar(textbox_select_mousepos)++;
								char_ = string_char_at(idVar(tbx, text), (IntType)(sVar(textbox_select_mousepos) + IntType(1)));
							}
							while (true)
							{
								char_ = string_char_at(idVar(tbx, text), (IntType)(sVar(textbox_select_mousepos) + IntType(1)));
								if (char_ == /*""*/ STR(0) || char_ == /*" "*/ STR(21) || char_ == /*"\n"*/ STR(76))
									break;
								if (sVar(textbox_select_mouseline) == idVar(tbx, lines) - IntType(1) && sVar(textbox_select_mousepos) >= string_length(idArr(tbx, line).Value(sVar(textbox_select_mouseline))))
								{
									sVar(textbox_select_mousepos) = string_length(idArr(tbx, line).Value(sVar(textbox_select_mouseline)));
									break;
								}
								sVar(textbox_select_mousepos)++;
								while (sVar(textbox_select_mousepos) > string_length(idArr(tbx, line).Value(sVar(textbox_select_mouseline))))
								{
									sVar(textbox_select_mouseline)++;
									sVar(textbox_select_mousepos) = IntType(0);
								}
								
							}
							
						}
						else
						{
							StringType char_ = string_char_at(idVar(tbx, text), (IntType)(sVar(textbox_select_mousepos)));
							if (char_ == /*" "*/ STR(21) || char_ == /*"\n"*/ STR(76) || sVar(textbox_select_mousepos) == IntType(0))
							{
								sVar(textbox_select_mousepos)--;
								char_ = string_char_at(idVar(tbx, text), (IntType)(sVar(textbox_select_mousepos)));
							}
							while (true)
							{
								char_ = string_char_at(idVar(tbx, text), (IntType)(sVar(textbox_select_mousepos)));
								if (char_ == /*""*/ STR(0) || char_ == /*" "*/ STR(21) || char_ == /*"\n"*/ STR(76) || (idArr(tbx, line).Value(sVar(textbox_select_mouseline)) != /*""*/ STR(0) && sVar(textbox_select_mousepos) == IntType(0)))
									break;
								if (sVar(textbox_select_mouseline) == IntType(0) && sVar(textbox_select_mousepos) <= IntType(0))
								{
									sVar(textbox_select_mousepos) = IntType(0);
									break;
								}
								sVar(textbox_select_mousepos)--;
								while (sVar(textbox_select_mousepos) < IntType(0))
								{
									sVar(textbox_select_mouseline)--;
									sVar(textbox_select_mousepos) = string_length(idArr(tbx, line).Value(sVar(textbox_select_mouseline)));
								}
								
							}
							
						}
						
					}
					else
					{
						sVar(textbox_select_mousepos) += (key_press.Value(vk_right) - key_press.Value(vk_left));
						if (sVar(textbox_select_mousepos) > string_length(idArr(tbx, line).Value(sVar(textbox_select_mouseline))))
						{
							if (sVar(textbox_select_mouseline) < idVar(tbx, lines) - IntType(1))
							{
								sVar(textbox_select_mouseline)++;
								sVar(textbox_select_mousepos) = IntType(0);
							}
							else
								sVar(textbox_select_mousepos)--;
							
						}
						if (sVar(textbox_select_mousepos) < IntType(0))
						{
							if (sVar(textbox_select_mouseline) > IntType(0))
							{
								sVar(textbox_select_mouseline)--;
								sVar(textbox_select_mousepos) = string_length(idArr(tbx, line).Value(sVar(textbox_select_mouseline)));
							}
							else
								sVar(textbox_select_mousepos)++;
							
						}
					}
					
				}
				if (!(idReal(tbx, single_line) > 0) && (key_press.Value(vk_up) || key_press.Value(vk_down)))
				{
					IntType currentx, nextx;
					currentx = string_width(string_copy(idArr(tbx, line).Value(sVar(textbox_select_mouseline)), IntType(1), (IntType)(sVar(textbox_select_mousepos))));
					nextx = IntType(0);
					sVar(textbox_select_mouseline) += key_press.Value(vk_down) - key_press.Value(vk_up);
					for (sVar(textbox_select_mousepos) = IntType(0); sVar(textbox_select_mousepos) <= string_length(idArr(tbx, line).Value(sVar(textbox_select_mouseline))); sVar(textbox_select_mousepos)++)
					{
						nextx += string_width(string_char_at(idArr(tbx, line).Value(sVar(textbox_select_mouseline)), (IntType)(sVar(textbox_select_mousepos))));
						if (nextx > currentx)
							break;
					}
				}
				if (!keyboard_check(vk_shift))
				{
					sVar(textbox_select_clickline) = sVar(textbox_select_mouseline);
					sVar(textbox_select_clickpos) = sVar(textbox_select_mousepos);
				}
				sVar(textbox_select_startline) = sVar(textbox_select_mouseline);
				sVar(textbox_select_startpos) = sVar(textbox_select_mousepos);
				sVar(textbox_select_endline) = sVar(textbox_select_mouseline);
				sVar(textbox_select_endpos) = sVar(textbox_select_mousepos);
				sInt(textbox_marker) = current_time();
			}
			action = -IntType(1);
			if ((keyboard_check(vk_control) && sVar(window_busy) == /*""*/ STR(0)) || sBool(context_menu_tbx_action))
			{
				if ((!(idReal(tbx, read_only) > 0) && keyboard_check_pressed((IntType)'X')) || sBool(context_menu_tbx_cut))
					action = IntType(0);
				if (keyboard_check_pressed((IntType)'C') || sBool(context_menu_tbx_copy))
					action = IntType(1);
				if ((!(idReal(tbx, read_only) > 0) && key_press.Value((IntType)'V')) || sBool(context_menu_tbx_paste))
					action = IntType(2);
				if (keyboard_check_pressed((IntType)'A') || sBool(context_menu_tbx_select_all))
					action = IntType(4);
				sBool(context_menu_tbx_action) = false;
				sBool(context_menu_tbx_cut) = false;
				sBool(context_menu_tbx_copy) = false;
				sBool(context_menu_tbx_paste) = false;
				sBool(context_menu_tbx_select_all) = false;
			}
			switch ((IntType)action)
			{
				case IntType(0):
				case IntType(1):
				{
					str = /*""*/ STR(0);
					if (sVar(textbox_select_startline) == sVar(textbox_select_endline))
						str = string_copy(idArr(tbx, line).Value(sVar(textbox_select_startline)), (IntType)(sVar(textbox_select_startpos) + IntType(1)), (IntType)(sVar(textbox_select_endpos) - sVar(textbox_select_startpos)));
					else
					{
						for (l = sVar(textbox_select_startline); l <= sVar(textbox_select_endline); l++)
						{
							if (l == sVar(textbox_select_startline))
								str += string_delete(idArr(tbx, line).Value(l), IntType(1), (IntType)(sVar(textbox_select_startpos)));
							else
								if (l == sVar(textbox_select_endline))
									str += string_copy(idArr(tbx, line).Value(l), IntType(1), (IntType)(sVar(textbox_select_endpos)));
								else
									str += idArr(tbx, line).Value(l);
							
							
							if (l < sVar(textbox_select_endline))
								if (!idArr(tbx, line_wrap).Value(l + IntType(1)) && !idArr(tbx, line_single).Value(l))
									str += /*"\r\n"*/ STR(3868);
						}
					}
					
					if (str != /*""*/ STR(0))
						clipboard_set_text(str);
					if (action == IntType(0))
						deletetext = IntType(2);
					break;
				}
				
				case IntType(2):
				{
					inserttext = string(clipboard_get_text());
					inserttext = string_replace_all(inserttext, /*"\r\n"*/ STR(3868), /*"\n"*/ STR(76));
					break;
				}
				
				case IntType(3):
				{
					deletetext = IntType(2);
					break;
				}
				
				case IntType(4):
				{
					sVar(textbox_select_startline) = IntType(0);
					sVar(textbox_select_startpos) = IntType(0);
					sVar(textbox_select_endline) = idVar(tbx, lines) - IntType(1);
					sVar(textbox_select_endpos) = string_length(idArr(tbx, line).Value(sVar(textbox_select_endline)));
					sVar(textbox_select_mouseline) = sVar(textbox_select_endline);
					sVar(textbox_select_mousepos) = sVar(textbox_select_endpos);
					sVar(textbox_select_clickline) = IntType(0);
					sVar(textbox_select_clickpos) = IntType(0);
					break;
				}
				
			}
			
			VarType line = sVar(textbox_select_mouseline);
			if (keyboard_check_pressed(vk_home))
			{
				if (keyboard_check(vk_control))
					line = IntType(0);
				sVar(textbox_select_startline) = line;
				sVar(textbox_select_startpos) = IntType(0);
				sVar(textbox_select_endline) = line;
				sVar(textbox_select_endpos) = IntType(0);
				sVar(textbox_select_mouseline) = line;
				sVar(textbox_select_mousepos) = IntType(0);
				sVar(textbox_select_clickline) = line;
				sVar(textbox_select_clickpos) = IntType(0);
			}
			else
				if (keyboard_check_pressed(vk_end))
				{
					if (keyboard_check(vk_control))
						line = idVar(tbx, lines) - IntType(1);
					line = line;
					sVar(textbox_select_startpos) = string_length(idArr(tbx, line).Value(sVar(textbox_select_endline)));
					sVar(textbox_select_endline) = line;
					sVar(textbox_select_endpos) = sVar(textbox_select_startpos);
					sVar(textbox_select_mouseline) = line;
					sVar(textbox_select_mousepos) = sVar(textbox_select_startpos);
					sVar(textbox_select_clickline) = line;
					sVar(textbox_select_clickpos) = sVar(textbox_select_startpos);
				}
			
			if (idStr(tbx, filter_chars) != /*""*/ STR(0) && inserttext != /*""*/ STR(0))
			{
				str = /*""*/ STR(0);
				for (p = IntType(1); p <= string_length(inserttext); p++)
				{
					c = string_char_at(inserttext, (IntType)(p));
					str += string_repeat(c, (IntType)(string_pos(c, idStr(tbx, filter_chars)) > IntType(0)));
				}
				inserttext = str;
			}
			if (deletetext != IntType(0) || inserttext != /*""*/ STR(0))
			{
				if (sVar(textbox_select_startline) != sVar(textbox_select_endline) || sVar(textbox_select_startpos) != sVar(textbox_select_endpos))
				{
					if (sVar(textbox_select_startline) == sVar(textbox_select_endline))
						idArr(tbx, line)[sVar(textbox_select_startline)] = string_delete(idArr(tbx, line).Value(sVar(textbox_select_startline)), (IntType)(sVar(textbox_select_startpos) + IntType(1)), (IntType)(sVar(textbox_select_endpos) - sVar(textbox_select_startpos)));
					else
					{
						RealType linestodelete = sVar(textbox_select_endline) - sVar(textbox_select_startline);
						idArr(tbx, line)[sVar(textbox_select_startline)] = string_copy(idArr(tbx, line).Value(sVar(textbox_select_startline)), IntType(1), (IntType)(sVar(textbox_select_startpos))) + string_delete(idArr(tbx, line).Value(sVar(textbox_select_endline)), IntType(1), (IntType)(sVar(textbox_select_endpos)));
						idVar(tbx, lines) -= linestodelete;
						for (l = sVar(textbox_select_startline) + IntType(1); l < idVar(tbx, lines); l++)
						{
							idArr(tbx, line)[l] = idArr(tbx, line).Value(l + linestodelete);
							idArr(tbx, line_wrap)[l] = idArr(tbx, line_wrap).Value(l + linestodelete);
							idArr(tbx, line_single)[l] = idArr(tbx, line_single).Value(l + linestodelete);
						}
					}
					
				}
				else
					if (deletetext < IntType(2))
					{
						if (deletetext == IntType(1))
						{
							if (sVar(textbox_select_startpos) > IntType(0))
							{
								idArr(tbx, line)[sVar(textbox_select_startline)] = string_delete(idArr(tbx, line).Value(sVar(textbox_select_startline)), (IntType)(sVar(textbox_select_startpos)), IntType(1));
								sVar(textbox_select_startpos)--;
							}
							else
								if (sVar(textbox_select_startline) > IntType(0))
								{
									sVar(textbox_select_startline)--;
									sVar(textbox_select_startpos) = string_length(idArr(tbx, line).Value(sVar(textbox_select_startline)));
									if (idArr(tbx, line_wrap).Value(sVar(textbox_select_startline) + IntType(1)))
									{
										sVar(textbox_select_startpos)--;
										idArr(tbx, line)[sVar(textbox_select_startline)] = string_copy(idArr(tbx, line).Value(sVar(textbox_select_startline)), IntType(1), (IntType)(sVar(textbox_select_startpos)));
									}
									idArr(tbx, line)[sVar(textbox_select_startline)] = idArr(tbx, line).Value(sVar(textbox_select_startline)) + idArr(tbx, line).Value(sVar(textbox_select_startline) + IntType(1));
									idVar(tbx, lines)--;
									for (l = sVar(textbox_select_startline) + IntType(1); l < idVar(tbx, lines); l++)
									{
										idArr(tbx, line)[l] = idArr(tbx, line).Value(l + IntType(1));
										idArr(tbx, line_wrap)[l] = idArr(tbx, line_wrap).Value(l + IntType(1));
										idArr(tbx, line_single)[l] = idArr(tbx, line_single).Value(l + IntType(1));
									}
								}
							
						}
						else
							if (deletetext == -IntType(1))
							{
								if (sVar(textbox_select_startpos) < string_length(idArr(tbx, line).Value(sVar(textbox_select_startline))))
									idArr(tbx, line)[sVar(textbox_select_startline)] = string_delete(idArr(tbx, line).Value(sVar(textbox_select_startline)), (IntType)(sVar(textbox_select_startpos) + IntType(1)), IntType(1));
								else
									if (sVar(textbox_select_startline) < idVar(tbx, lines) - IntType(1))
									{
										if (idArr(tbx, line_wrap).Value(sVar(textbox_select_startline) + IntType(1)))
											idArr(tbx, line)[sVar(textbox_select_startline) + IntType(1)] = string_delete(idArr(tbx, line).Value(sVar(textbox_select_startline) + IntType(1)), IntType(1), IntType(1));
										else
										{
											idArr(tbx, line)[sVar(textbox_select_startline)] += idArr(tbx, line).Value(sVar(textbox_select_startline) + IntType(1));
											idVar(tbx, lines)--;
											for (l = sVar(textbox_select_startline) + IntType(1); l < idVar(tbx, lines); l++)
											{
												idArr(tbx, line)[l] = idArr(tbx, line).Value(l + IntType(1));
												idArr(tbx, line_wrap)[l] = idArr(tbx, line_wrap).Value(l + IntType(1));
												idArr(tbx, line_single)[l] = idArr(tbx, line_single).Value(l + IntType(1));
											}
										}
										
									}
								
							}
						
					}
				
				idVar(tbx, text) = /*""*/ STR(0);
				for (l = IntType(0); l < idVar(tbx, lines); l++)
				{
					idVar(tbx, text) += idArr(tbx, line).Value(l);
					if (l < idVar(tbx, lines) - IntType(1) && !idArr(tbx, line_wrap).Value(l + IntType(1)))
						idVar(tbx, text) += /*"\n"*/ STR(76);
				}
				sVar(textbox_select_clickline) = sVar(textbox_select_startline);
				sVar(textbox_select_clickpos) = sVar(textbox_select_startpos);
				sVar(textbox_select_mouseline) = sVar(textbox_select_startline);
				sVar(textbox_select_mousepos) = sVar(textbox_select_startpos);
				sVar(textbox_select_endline) = sVar(textbox_select_startline);
				sVar(textbox_select_endpos) = sVar(textbox_select_startpos);
			}
			if (idInt(tbx, max_chars) > IntType(0))
			{
				RealType maxlen = idInt(tbx, max_chars) - string_length(idVar(tbx, text));
				if (string_length(inserttext) > maxlen)
					inserttext = string_copy(inserttext, IntType(1), (IntType)(maxlen));
			}
			if (inserttext != /*""*/ STR(0))
			{
				sInt(textbox_marker) = current_time();
				if (idReal(tbx, single_line) > 0)
					inserttext = string_replace_all(inserttext, /*"\n"*/ STR(76), /*" "*/ STR(21));
				sVar(realmousepos) = sVar(textbox_select_mousepos);
				for (l = IntType(0); l < sVar(textbox_select_mouseline); l++)
					sVar(realmousepos) += string_length(idArr(tbx, line).Value(l)) + (!idArr(tbx, line_wrap).Value(l + IntType(1)) && !idArr(tbx, line_single).Value(l));
				idVar(tbx, text) = string_copy(idVar(tbx, text), IntType(1), (IntType)(sVar(realmousepos))) + inserttext + string_delete(idVar(tbx, text), IntType(1), (IntType)(sVar(realmousepos)));
				if (string_pos(/*"\n"*/ STR(76), inserttext) > IntType(0))
				{
					inserttext += /*"\n"*/ STR(76);
					a = idArr(tbx, line).Value(sVar(textbox_select_mouseline));
					b = -IntType(1);
					while (inserttext != /*""*/ STR(0))
					{
						b++;
						str[b] = string_copy(inserttext, IntType(1), (IntType)(string_pos(/*"\n"*/ STR(76), inserttext) - IntType(1)));
						if (idStr(tbx, replace_char) != /*""*/ STR(0))
							str[b] = string_repeat(idStr(tbx, replace_char), string_length(str.Value(b)));
						inserttext = string_delete(inserttext, IntType(1), string_pos(/*"\n"*/ STR(76), inserttext));
					}
					
					idVar(tbx, lines) += b;
					for (l = idVar(tbx, lines) - IntType(1); l >= sVar(textbox_select_mouseline) + b; l--)
					{
						idArr(tbx, line)[l] = idArr(tbx, line).Value(l - b);
						idArr(tbx, line_wrap)[l] = idArr(tbx, line_wrap).Value(l - b);
						idArr(tbx, line_single)[l] = idArr(tbx, line_single).Value(l - b);
					}
					for (l = IntType(0); l <= b; l++)
					{
						if (l == IntType(0))
						{
							idArr(tbx, line)[sVar(textbox_select_mouseline) + l] = string_copy(a, IntType(1), (IntType)(sVar(textbox_select_mousepos))) + str.Value(l);
							idArr(tbx, line_single)[sVar(textbox_select_mouseline) + l] = false;
						}
						else
							if (l == b)
							{
								idArr(tbx, line)[sVar(textbox_select_mouseline) + l] = str.Value(l) + string_delete(a, IntType(1), (IntType)(sVar(textbox_select_mousepos)));
								idArr(tbx, line_wrap)[sVar(textbox_select_mouseline) + l] = false;
							}
							else
								idArr(tbx, line)[sVar(textbox_select_mouseline) + l] = str.Value(l);
						
						
					}
					sVar(textbox_select_mouseline) += b;
					sVar(textbox_select_mousepos) = string_length(str.Value(b));
					inserttext = /*" "*/ STR(21);
				}
				else
				{
					if (idStr(tbx, replace_char) != /*""*/ STR(0))
						inserttext = string_repeat(idStr(tbx, replace_char), string_length(inserttext));
					idArr(tbx, line)[sVar(textbox_select_startline)] = string_copy(idArr(tbx, line).Value(sVar(textbox_select_startline)), IntType(1), (IntType)(sVar(textbox_select_mousepos))) + inserttext + string_delete(idArr(tbx, line).Value(sVar(textbox_select_startline)), IntType(1), (IntType)(sVar(textbox_select_mousepos)));
					sVar(textbox_select_mousepos) += string_length(inserttext);
				}
				
				sVar(textbox_select_clickline) = sVar(textbox_select_mouseline);
				sVar(textbox_select_clickpos) = sVar(textbox_select_mousepos);
				sVar(textbox_select_startline) = sVar(textbox_select_mouseline);
				sVar(textbox_select_startpos) = sVar(textbox_select_mousepos);
				sVar(textbox_select_endline) = sVar(textbox_select_mouseline);
				sVar(textbox_select_endpos) = sVar(textbox_select_mousepos);
			}
			if (inserttext != /*""*/ STR(0) || deletetext != IntType(0) || key_press.Value(vk_left) || key_press.Value(vk_right) || key_press.Value(vk_up) || key_press.Value(vk_down))
			{
				if (idReal(tbx, single_line) > 0)
				{
					if (sVar(textbox_select_mousepos) < idVar(tbx, start))
						idVar(tbx, start) = sVar(textbox_select_mousepos);
					if (sVar(textbox_select_mousepos) > idVar(tbx, start) + idInt(tbx, chars) - IntType(1))
						idVar(tbx, start) = sVar(textbox_select_mousepos) - idInt(tbx, chars);
				}
				else
				{
					if (sVar(textbox_select_mouseline) < idVar(tbx, start))
						idVar(tbx, start) = sVar(textbox_select_mouseline);
					if (sVar(textbox_select_mouseline) >= idVar(tbx, start) + floor((RealType)h / lineheight))
						idVar(tbx, start) = sVar(textbox_select_mouseline) - floor((RealType)h / lineheight) + IntType(1);
				}
				
			}
			if (!sBool(mouse_left) && (sVar(window_busy) == string(tbx) + /*"click"*/ STR(1100)))
				sVar(window_busy) = /*""*/ STR(0);
			if (!sBool(mouse_left) && (sVar(window_busy) == string(tbx)))
				sVar(window_busy) = string(tbx) + /*"tbxrelease"*/ STR(3869);
			if (sVar(window_busy) == string(tbx))
			{
				sInt(textbox_marker) = current_time();
				if (idReal(tbx, single_line) > 0)
				{
					if (gmlGlobal::mouse_x < xx)
						idVar(tbx, start)--;
					if (gmlGlobal::mouse_x > xx + w)
						idVar(tbx, start)++;
				}
				else
				{
					if (gmlGlobal::mouse_y < yy)
						idVar(tbx, start)--;
					if (gmlGlobal::mouse_y > yy + h)
						idVar(tbx, start)++;
				}
				
			}
			if (sInt(textbox_click) > IntType(0))
			{
				if (sVar(textbox_select_mouseline) == sVar(textbox_select_clickline))
				{
					sVar(textbox_select_startline) = sVar(textbox_select_mouseline);
					sVar(textbox_select_endline) = sVar(textbox_select_mouseline);
					if (sVar(textbox_select_mousepos) >= sVar(textbox_select_clickpos))
					{
						sVar(textbox_select_startpos) = sVar(textbox_select_clickpos);
						sVar(textbox_select_endpos) = sVar(textbox_select_mousepos);
					}
					else
					{
						sVar(textbox_select_startpos) = sVar(textbox_select_mousepos);
						sVar(textbox_select_endpos) = sVar(textbox_select_clickpos);
					}
					
				}
				if (sVar(textbox_select_mouseline) > sVar(textbox_select_clickline))
				{
					sVar(textbox_select_startline) = sVar(textbox_select_clickline);
					sVar(textbox_select_startpos) = sVar(textbox_select_clickpos);
					sVar(textbox_select_endline) = sVar(textbox_select_mouseline);
					sVar(textbox_select_endpos) = sVar(textbox_select_mousepos);
				}
				if (sVar(textbox_select_mouseline) < sVar(textbox_select_clickline))
				{
					sVar(textbox_select_startline) = sVar(textbox_select_mouseline);
					sVar(textbox_select_startpos) = sVar(textbox_select_mousepos);
					sVar(textbox_select_endline) = sVar(textbox_select_clickline);
					sVar(textbox_select_endpos) = sVar(textbox_select_clickpos);
				}
			}
		}
		if (idReal(tbx, single_line) > 0)
		{
			idVar(tbx, start) = max({ IntType(0), idVar(tbx, start) });
			ww = IntType(0);
			for (a = string_length(idArr(tbx, line).Value(IntType(0))); a >= IntType(0); a--)
			{
				ww += string_width(string_char_at(idArr(tbx, line).Value(IntType(0)), (IntType)(a)));
				b = a;
				if (ww > w)
					break;
			}
			idVar(tbx, start) = min({ b, idVar(tbx, start) });
			ww = IntType(0);
			idInt(tbx, chars) = IntType(0);
			for (a = idVar(tbx, start) + IntType(1); a <= string_length(idArr(tbx, line).Value(IntType(0))); a++)
			{
				ww += string_width(string_char_at(idArr(tbx, line).Value(IntType(0)), (IntType)(a)));
				if (ww > w)
					break;
				idInt(tbx, chars)++;
			}
		}
		else
		{
			if (changetext || idVar(tbx, last_width) != w || inserttext != /*""*/ STR(0) || deletetext != IntType(0))
			{
				for (l = IntType(1); l < idVar(tbx, lines); l++)
				{
					ww = string_width(idArr(tbx, line).Value(l - IntType(1)));
					if (!idArr(tbx, line_wrap).Value(l) || ww > w)
						continue;
					if (idArr(tbx, line_single).Value(l - IntType(1)))
					{
						for (p = IntType(1); p <= string_length(idArr(tbx, line).Value(l)); p++)
						{
							if (ww + string_width(string_copy(idArr(tbx, line).Value(l), IntType(1), (IntType)(p))) > w)
								break;
							a = string_char_at(idArr(tbx, line).Value(l), (IntType)(p + IntType(1)));
							if (a == /*" "*/ STR(21) || a == /*"-"*/ STR(1127))
							{
								p++;
								idArr(tbx, line_single)[l - IntType(1)] = false;
								break;
							}
							if (p == string_length(idArr(tbx, line).Value(l)) && !idArr(tbx, line_single).Value(l))
								idArr(tbx, line_single)[l - IntType(1)] = false;
						}
						if (p == IntType(1))
							continue;
						a = string_length(idArr(tbx, line).Value(l - IntType(1)));
						if (sVar(textbox_select_mouseline) == l && sVar(textbox_select_mousepos) <= p)
						{
							sVar(textbox_select_mouseline)--;
							sVar(textbox_select_mousepos) += a;
						}
						if (sVar(textbox_select_clickline) == l && sVar(textbox_select_clickpos) <= p)
						{
							sVar(textbox_select_clickline)--;
							sVar(textbox_select_clickpos) += a;
						}
						if (sVar(textbox_select_endline) == l && sVar(textbox_select_endpos) <= p)
						{
							sVar(textbox_select_endline)--;
							sVar(textbox_select_endpos) += a;
						}
						if (sVar(textbox_select_startline) == l && sVar(textbox_select_startpos) <= p)
						{
							sVar(textbox_select_startline)--;
							sVar(textbox_select_startpos) += a;
						}
						if (sVar(textbox_select_mouseline) == l)
							sVar(textbox_select_mousepos) -= p;
						if (sVar(textbox_select_clickline) == l)
							sVar(textbox_select_clickpos) -= p;
						if (sVar(textbox_select_endline) == l)
							sVar(textbox_select_endpos) -= p;
						if (sVar(textbox_select_startline) == l)
							sVar(textbox_select_startpos) -= p;
						idArr(tbx, line)[l - IntType(1)] += string_copy(idArr(tbx, line).Value(l), IntType(1), (IntType)(p));
						idArr(tbx, line)[l] = string_delete(idArr(tbx, line).Value(l), IntType(1), (IntType)(p));
					}
					while (idArr(tbx, line).Value(l) != /*""*/ STR(0))
					{
						p = string_pos(/*" "*/ STR(21), idArr(tbx, line).Value(l));
						if (p == IntType(0))
							p = string_pos(/*" - "*/ STR(3870), idArr(tbx, line).Value(l));
						if (p == IntType(0))
							p = string_length(idArr(tbx, line).Value(l));
						if (ww + string_width(string_copy(idArr(tbx, line).Value(l), IntType(1), (IntType)(p - IntType(1)))) > w)
							break;
						a = string_length(idArr(tbx, line).Value(l - IntType(1)));
						if (sVar(textbox_select_mouseline) == l && sVar(textbox_select_mousepos) <= p)
						{
							sVar(textbox_select_mouseline)--;
							sVar(textbox_select_mousepos) += a;
						}
						if (sVar(textbox_select_clickline) == l && sVar(textbox_select_clickpos) <= p)
						{
							sVar(textbox_select_clickline)--;
							sVar(textbox_select_clickpos) += a;
						}
						if (sVar(textbox_select_endline) == l && sVar(textbox_select_endpos) <= p)
						{
							sVar(textbox_select_endline)--;
							sVar(textbox_select_endpos) += a;
						}
						if (sVar(textbox_select_startline) == l && sVar(textbox_select_startpos) <= p)
						{
							sVar(textbox_select_startline)--;
							sVar(textbox_select_startpos) += a;
						}
						if (sVar(textbox_select_mouseline) == l)
							sVar(textbox_select_mousepos) -= p;
						if (sVar(textbox_select_clickline) == l)
							sVar(textbox_select_clickpos) -= p;
						if (sVar(textbox_select_endline) == l)
							sVar(textbox_select_endpos) -= p;
						if (sVar(textbox_select_startline) == l)
							sVar(textbox_select_startpos) -= p;
						idArr(tbx, line)[l - IntType(1)] += string_copy(idArr(tbx, line).Value(l), IntType(1), (IntType)(p));
						idArr(tbx, line)[l] = string_delete(idArr(tbx, line).Value(l), IntType(1), (IntType)(p));
					}
					
					if (idArr(tbx, line).Value(l) == /*""*/ STR(0))
					{
						idVar(tbx, lines)--;
						for (a = l; a < idVar(tbx, lines); a++)
						{
							idArr(tbx, line)[a] = idArr(tbx, line).Value(a + IntType(1));
							idArr(tbx, line_wrap)[a] = idArr(tbx, line_wrap).Value(a + IntType(1));
							idArr(tbx, line_single)[a] = idArr(tbx, line_single).Value(a + IntType(1));
							if (sVar(textbox_select_mouseline) == a + IntType(1))
								sVar(textbox_select_mouseline)--;
							if (sVar(textbox_select_clickline) == a + IntType(1))
								sVar(textbox_select_clickline)--;
							if (sVar(textbox_select_endline) == a + IntType(1))
								sVar(textbox_select_endline)--;
							if (sVar(textbox_select_startline) == a + IntType(1))
								sVar(textbox_select_startline)--;
						}
						l--;
					}
				}
				for (l = IntType(0); l < idVar(tbx, lines); l++)
				{
					if (string_width(idArr(tbx, line).Value(l)) > w)
					{
						idArr(tbx, line_single)[l] = false;
						for (p = string_length(idArr(tbx, line).Value(l)); p > IntType(1); p--)
						{
							a = string_char_at(idArr(tbx, line).Value(l), (IntType)(p));
							if ((a == /*" "*/ STR(21) || a == /*"-"*/ STR(1127)) && string_width(string_copy(idArr(tbx, line).Value(l), IntType(1), (IntType)(p - IntType(1)))) < w)
								break;
						}
						if (p == IntType(1))
						{
							idArr(tbx, line_single)[l] = true;
							for (p = string_length(idArr(tbx, line).Value(l)) - IntType(1); p > IntType(1); p--)
								if (string_width(string_copy(idArr(tbx, line).Value(l), IntType(1), (IntType)(p))) < w)
									break;
						}
						if (p == IntType(0))
							continue;
						if (l == idVar(tbx, lines) - IntType(1))
							a = true;
						else
							a = !idArr(tbx, line_wrap).Value(l + IntType(1));
						
						if (a > 0)
						{
							for (b = idVar(tbx, lines); b > l; b--)
							{
								idArr(tbx, line)[b] = idArr(tbx, line).Value(b - IntType(1));
								idArr(tbx, line_wrap)[b] = idArr(tbx, line_wrap).Value(b - IntType(1));
								idArr(tbx, line_single)[b] = idArr(tbx, line_single).Value(b - IntType(1));
								if (sVar(textbox_select_mouseline) == b)
									sVar(textbox_select_mouseline)++;
								if (sVar(textbox_select_clickline) == b)
									sVar(textbox_select_clickline)++;
								if (sVar(textbox_select_endline) == b)
									sVar(textbox_select_endline)++;
								if (sVar(textbox_select_startline) == b)
									sVar(textbox_select_startline)++;
							}
							idVar(tbx, lines)++;
							idArr(tbx, line)[l + IntType(1)] = string_delete(idArr(tbx, line).Value(l), IntType(1), (IntType)(p));
							idArr(tbx, line_wrap)[l + IntType(1)] = true;
							idArr(tbx, line_single)[l + IntType(1)] = false;
						}
						else
							idArr(tbx, line)[l + IntType(1)] = string_delete(idArr(tbx, line).Value(l), IntType(1), (IntType)(p)) + idArr(tbx, line).Value(l + IntType(1));
						
						a = string_length(idArr(tbx, line).Value(l)) - p;
						if (sVar(textbox_select_mouseline) == l + IntType(1))
							sVar(textbox_select_mousepos) += a;
						if (sVar(textbox_select_clickline) == l + IntType(1))
							sVar(textbox_select_clickpos) += a;
						if (sVar(textbox_select_endline) == l + IntType(1))
							sVar(textbox_select_endpos) += a;
						if (sVar(textbox_select_startline) == l + IntType(1))
							sVar(textbox_select_startpos) += a;
						if (sVar(textbox_select_mouseline) == l && sVar(textbox_select_mousepos) >= p)
						{
							sVar(textbox_select_mouseline)++;
							sVar(textbox_select_mousepos) -= p;
						}
						if (sVar(textbox_select_clickline) == l && sVar(textbox_select_clickpos) >= p)
						{
							sVar(textbox_select_clickline)++;
							sVar(textbox_select_clickpos) -= p;
						}
						if (sVar(textbox_select_endline) == l && sVar(textbox_select_endpos) >= p)
						{
							sVar(textbox_select_endline)++;
							sVar(textbox_select_endpos) -= p;
						}
						if (sVar(textbox_select_startline) == l && sVar(textbox_select_startpos) >= p)
						{
							sVar(textbox_select_startline)++;
							sVar(textbox_select_startpos) -= p;
						}
						idArr(tbx, line)[l] = string_copy(idArr(tbx, line).Value(l), IntType(1), (IntType)(p));
					}
				}
				if (sVar(textbox_select_mouseline) < idVar(tbx, start))
					idVar(tbx, start) = sVar(textbox_select_mouseline);
				if (sVar(textbox_select_mouseline) >= idVar(tbx, start) + floor((RealType)h / lineheight))
					idVar(tbx, start) = sVar(textbox_select_mouseline) - floor((RealType)h / lineheight) + IntType(1);
			}
			idVar(tbx, start) = max({ IntType(0), min({ idVar(tbx, start), idVar(tbx, lines) - floor((RealType)h / lineheight) }) });
		}
		
		draw_set_halign(fa_left);
		draw_set_valign(fa_top);
		IntType limit = string_width(string_limit(idVar(tbx, text) + idVar(tbx, suffix), w, /*""*/ STR(0)));
		textx = xx + ((w - min({ w, limit })) * (IntType)right);
		for (l = idVar(tbx, start) * (IntType)!(idReal(tbx, single_line) > 0); l < idVar(tbx, lines); l++)
		{
			RealType ly = (l - idVar(tbx, start) * (IntType)!(idReal(tbx, single_line) > 0)) * lineheight;
			if (ly + lineheight > h)
				break;
			if ((sVar(window_busy) == /*""*/ STR(0) && sVar(window_focus) == string(tbx)) || sVar(window_busy) == string(tbx))
			{
				if (l == idVar(tbx, lines) - IntType(1))
					hh = h - ly;
				else
					hh = lineheight;
				
				if ((gmlGlobal::mouse_x >= xx || sVar(window_busy) == string(tbx)) && (gmlGlobal::mouse_x < xx + w || sVar(window_busy) == string(tbx)) && (gmlGlobal::mouse_y >= yy + ly || (sVar(window_busy) == string(tbx) && ly == IntType(0))) && (gmlGlobal::mouse_y < yy + ly + hh || (sVar(window_busy) == string(tbx) && (ly + lineheight > h || l == idVar(tbx, lines) - IntType(1)))))
				{
					if (sBool(mouse_left))
					{
						if (idReal(tbx, select_on_focus) > 0 && sVar(textbox_lastfocus) != tbx)
						{
							sVar(textbox_select_startline) = IntType(0);
							sVar(textbox_select_startpos) = IntType(0);
							sVar(textbox_select_endline) = idVar(tbx, lines) - IntType(1);
							sVar(textbox_select_endpos) = string_length(idArr(tbx, line).Value(sVar(textbox_select_endline)));
							sVar(textbox_select_mouseline) = sVar(textbox_select_endline);
							sVar(textbox_select_mousepos) = sVar(textbox_select_endpos);
							sVar(textbox_select_clickline) = IntType(0);
							sVar(textbox_select_clickpos) = IntType(0);
							sInt(textbox_marker) = current_time();
							sVar(window_focus) = string(tbx);
							sVar(window_busy) = string(tbx) + /*"click"*/ STR(1100);
						}
						else
						{
							sVar(window_busy) = string(tbx);
							ww = IntType(0);
							for (a = idVar(tbx, start) * idReal(tbx, single_line); a < string_length(idArr(tbx, line).Value(l)); a++)
							{
								b = string_width(string_char_at(idArr(tbx, line).Value(l), (IntType)(a + IntType(1))));
								ww += b;
								if (gmlGlobal::mouse_x < textx + ww - (RealType)b / 2.0)
									break;
							}
							sVar(textbox_select_mouseline) = l;
							sVar(textbox_select_mousepos) = a;
							if (sBool(mouse_left_pressed))
							{
								if (sVar(textbox_select_clickline) == sVar(textbox_select_mouseline) && sVar(textbox_select_clickpos) == sVar(textbox_select_mousepos))
								{
									if (current_time() - sInt(textbox_click) < IntType(500))
									{
										sVar(textbox_select_startline) = sVar(textbox_select_mouseline);
										sVar(textbox_select_startpos) = max({ IntType(1), sVar(textbox_select_mousepos) - IntType(1) });
										sVar(textbox_select_endline) = sVar(textbox_select_mouseline);
										sVar(textbox_select_endpos) = max({ IntType(1), sVar(textbox_select_mousepos) });
										while (true)
										{
											c = string_char_at(idArr(tbx, line).Value(sVar(textbox_select_startline)), (IntType)(sVar(textbox_select_startpos)));
											if (c == /*" "*/ STR(21) || c == /*", "*/ STR(1053) || c == /*"("*/ STR(1122) || c == /*")"*/ STR(1126) || c == /*"["*/ STR(1001) || c == /*"]"*/ STR(1250) || c == /*"+"*/ STR(1128))
												break;
											sVar(textbox_select_startpos)--;
											if (sVar(textbox_select_startpos) <= IntType(0))
											{
												if (sVar(textbox_select_startline) == IntType(0))
													break;
												if (!idArr(tbx, line_single).Value(sVar(textbox_select_startline) - IntType(1)))
													break;
												sVar(textbox_select_startline)--;
												sVar(textbox_select_startpos) = string_length(idArr(tbx, line).Value(sVar(textbox_select_startline)));
											}
											if (sVar(textbox_select_startpos) <= IntType(0))
												break;
										}
										
										while (true)
										{
											c = string_char_at(idArr(tbx, line).Value(sVar(textbox_select_endline)), (IntType)(sVar(textbox_select_endpos)));
											if (c == /*" "*/ STR(21) || c == /*", "*/ STR(1053) || c == /*"("*/ STR(1122) || c == /*")"*/ STR(1126) || c == /*"["*/ STR(1001) || c == /*"]"*/ STR(1250) || c == /*"+"*/ STR(1128))
												break;
											sVar(textbox_select_endpos)++;
											if (sVar(textbox_select_endpos) >= string_length(idArr(tbx, line).Value(sVar(textbox_select_endline))))
											{
												if (sVar(textbox_select_endline) == idVar(tbx, lines) - IntType(1))
													break;
												if (!idArr(tbx, line_single).Value(sVar(textbox_select_endline)))
													break;
												sVar(textbox_select_endline)++;
												sVar(textbox_select_endpos) = IntType(0);
											}
											if (sVar(textbox_select_endpos) >= string_length(idArr(tbx, line).Value(sVar(textbox_select_endline))))
												break;
										}
										
										sVar(textbox_select_mouseline) = sVar(textbox_select_endline);
										sVar(textbox_select_mousepos) = sVar(textbox_select_endpos);
										sInt(textbox_click) = IntType(0);
										mouse_clear(mb_left);
									}
									else
									{
										sInt(textbox_click) = current_time();
										sVar(textbox_select_startline) = sVar(textbox_select_mouseline);
										sVar(textbox_select_startpos) = sVar(textbox_select_mousepos);
										sVar(textbox_select_endline) = sVar(textbox_select_mouseline);
										sVar(textbox_select_endpos) = sVar(textbox_select_mousepos);
									}
									
								}
								else
								{
									sInt(textbox_click) = current_time();
									if (!keyboard_check(vk_shift) || sVar(textbox_lastfocus) != tbx)
									{
										sVar(textbox_select_startline) = sVar(textbox_select_mouseline);
										sVar(textbox_select_startpos) = sVar(textbox_select_mousepos);
										sVar(textbox_select_endline) = sVar(textbox_select_mouseline);
										sVar(textbox_select_endpos) = sVar(textbox_select_mousepos);
										sVar(textbox_select_clickline) = sVar(textbox_select_mouseline);
										sVar(textbox_select_clickpos) = sVar(textbox_select_mousepos);
									}
								}
								
								sInt(textbox_marker) = current_time();
								sVar(window_focus) = string(tbx);
								sVar(textbox_lastfocus) = tbx;
							}
						}
						
					}
				}
			}
			if (idReal(tbx, single_line) > 0)
			{
				if (sVar(window_focus) == string(tbx) && sVar(textbox_select_startpos) != sVar(textbox_select_endpos))
				{
					for (a = IntType(0); a < IntType(3); a++)
						str[a] = /*""*/ STR(0);
					if (sVar(textbox_select_endpos) < idVar(tbx, start) + IntType(1) || sVar(textbox_select_startpos) > idVar(tbx, start) + IntType(1) + idInt(tbx, chars))
						str[IntType(0)] = string_copy(idArr(tbx, line).Value(IntType(0)), (IntType)(idVar(tbx, start) + IntType(1)), idInt(tbx, chars));
					else
						if (sVar(textbox_select_startpos) <= idVar(tbx, start) && sVar(textbox_select_endpos) > idVar(tbx, start) + idInt(tbx, chars))
							str[IntType(1)] = string_copy(idArr(tbx, line).Value(IntType(0)), (IntType)(idVar(tbx, start) + IntType(1)), idInt(tbx, chars));
						else
							if (sVar(textbox_select_startpos) > idVar(tbx, start) && sVar(textbox_select_endpos) < idVar(tbx, start) + idInt(tbx, chars))
							{
								str[IntType(0)] = string_copy(idArr(tbx, line).Value(IntType(0)), (IntType)(idVar(tbx, start) + IntType(1)), (IntType)(sVar(textbox_select_startpos) - idVar(tbx, start)));
								str[IntType(1)] = string_copy(idArr(tbx, line).Value(IntType(0)), (IntType)(sVar(textbox_select_startpos) + IntType(1)), (IntType)(sVar(textbox_select_endpos) - sVar(textbox_select_startpos)));
								str[IntType(2)] = string_copy(idArr(tbx, line).Value(IntType(0)), (IntType)(sVar(textbox_select_endpos) + IntType(1)), (IntType)(idVar(tbx, start) + idInt(tbx, chars) - sVar(textbox_select_endpos)));
							}
							else
								if (sVar(textbox_select_startpos) <= idVar(tbx, start))
								{
									str[IntType(1)] = string_copy(idArr(tbx, line).Value(IntType(0)), (IntType)(idVar(tbx, start) + IntType(1)), (IntType)(sVar(textbox_select_endpos) - idVar(tbx, start)));
									str[IntType(2)] = string_copy(idArr(tbx, line).Value(IntType(0)), (IntType)(sVar(textbox_select_endpos) + IntType(1)), (IntType)(idVar(tbx, start) + idInt(tbx, chars) - sVar(textbox_select_endpos)));
								}
								else
								{
									str[IntType(0)] = string_copy(idArr(tbx, line).Value(IntType(0)), (IntType)(idVar(tbx, start) + IntType(1)), (IntType)(sVar(textbox_select_startpos) - idVar(tbx, start)));
									str[IntType(1)] = string_copy(idArr(tbx, line).Value(IntType(0)), (IntType)(sVar(textbox_select_startpos) + IntType(1)), (IntType)(idVar(tbx, start) + idInt(tbx, chars) - sVar(textbox_select_startpos)));
								}
							
						
					
					
					if (str.Value(IntType(0)) != /*""*/ STR(0))
					{
						draw_set_color((IntType)(textnormal));
						draw_set_alpha(textnormala);
						draw_text((IntType)(textx), (IntType)(yy), str.Value(IntType(0)));
					}
					if (str.Value(IntType(1)) != /*""*/ STR(0))
					{
						draw_set_color((IntType)(highlight));
						draw_set_alpha(1.0);
						draw_rectangle((IntType)(min({ textx + w, textx + string_width(str.Value(IntType(0))) })), (IntType)(yy), (IntType)(min({ textx + w, textx + string_width(str.Value(IntType(0)) + str.Value(IntType(1))) })), (IntType)(yy + lineheight), false);
						draw_set_color(texthighlight);
						draw_set_alpha(texthighlighta);
						draw_text((IntType)(textx + string_width(str.Value(IntType(0)))), (IntType)(yy), str.Value(IntType(1)));
					}
					if (str.Value(IntType(2)) != /*""*/ STR(0))
					{
						draw_set_color((IntType)(textnormal));
						draw_set_alpha(textnormala);
						draw_text((IntType)(textx + string_width(str.Value(IntType(0)) + str.Value(IntType(1)))), (IntType)(yy), str.Value(IntType(2)));
					}
				}
				else
				{
					StringType text = string_copy(idArr(tbx, line).Value(IntType(0)), (IntType)(idVar(tbx, start) + IntType(1)), idInt(tbx, chars));
					draw_set_color((IntType)(textnormal));
					draw_set_alpha(textnormala);
					draw_text((IntType)(textx), (IntType)(yy), text);
					draw_set_color((IntType)(textsuffix));
					draw_set_alpha(textsuffixa);
					draw_text((IntType)(textx + string_width(text)), (IntType)(yy), idVar(tbx, suffix));
				}
				
			}
			else
			{
				if (sVar(window_focus) == string(tbx) && (sVar(textbox_select_startline) != sVar(textbox_select_endline) || sVar(textbox_select_startpos) != sVar(textbox_select_endpos)))
				{
					for (a = IntType(0); a < IntType(3); a++)
						str[a] = /*""*/ STR(0);
					if (sVar(textbox_select_startline) == l && sVar(textbox_select_endline) == l)
					{
						str[IntType(0)] = string_copy(idArr(tbx, line).Value(l), IntType(1), (IntType)(sVar(textbox_select_startpos)));
						str[IntType(1)] = string_copy(idArr(tbx, line).Value(l), (IntType)(sVar(textbox_select_startpos) + IntType(1)), (IntType)(sVar(textbox_select_endpos) - sVar(textbox_select_startpos)));
						str[IntType(2)] = string_delete(idArr(tbx, line).Value(l), IntType(1), (IntType)(sVar(textbox_select_endpos)));
					}
					else
						if (sVar(textbox_select_startline) == l)
						{
							str[IntType(0)] = string_copy(idArr(tbx, line).Value(l), IntType(1), (IntType)(sVar(textbox_select_startpos)));
							str[IntType(1)] = string_delete(idArr(tbx, line).Value(l), IntType(1), (IntType)(sVar(textbox_select_startpos)));
						}
						else
							if (sVar(textbox_select_endline) == l)
							{
								str[IntType(1)] = string_copy(idArr(tbx, line).Value(l), IntType(1), (IntType)(sVar(textbox_select_endpos)));
								str[IntType(2)] = string_delete(idArr(tbx, line).Value(l), IntType(1), (IntType)(sVar(textbox_select_endpos)));
							}
							else
								if (sVar(textbox_select_startline) < l && sVar(textbox_select_endline) > l)
									str[IntType(1)] = idArr(tbx, line).Value(l);
								else
									str[IntType(0)] = idArr(tbx, line).Value(l);
							
						
					
					
					if (str.Value(IntType(0)) != /*""*/ STR(0))
					{
						draw_set_color((IntType)(textnormal));
						draw_set_alpha(textnormala);
						draw_text((IntType)(textx), (IntType)(yy + ly), str.Value(IntType(0)));
					}
					if (str.Value(IntType(1)) != /*""*/ STR(0))
					{
						draw_set_color((IntType)(highlight));
						draw_set_alpha(1.0);
						draw_rectangle((IntType)(min({ textx + w, textx + string_width(str.Value(IntType(0))) })), (IntType)(yy + ly), (IntType)(min({ textx + w, textx + string_width(str.Value(IntType(0)) + str.Value(IntType(1))) })), (IntType)(yy + ly + lineheight), false);
						draw_set_color(texthighlight);
						draw_set_alpha(texthighlighta);
						draw_text((IntType)(textx + string_width(str.Value(IntType(0)))), (IntType)(yy + ly), str.Value(IntType(1)));
					}
					if (str.Value(IntType(2)) != /*""*/ STR(0))
					{
						draw_set_color((IntType)(textnormal));
						draw_set_alpha(textnormala);
						draw_text((IntType)(textx + string_width(str.Value(IntType(0)) + str.Value(IntType(1)))), (IntType)(yy + ly), str.Value(IntType(2)));
					}
				}
				else
				{
					draw_set_color((IntType)(textnormal));
					draw_set_alpha(textnormala);
					draw_text((IntType)(textx), (IntType)(yy + ly), idArr(tbx, line).Value(l));
				}
				
			}
			
		}
		if (sVar(window_focus) == string(tbx) && !(idReal(tbx, read_only) > 0))
		{
			a = string_width(string_copy(idArr(tbx, line).Value(sVar(textbox_select_mouseline)), IntType(1), (IntType)(sVar(textbox_select_mousepos))));
			b = (sVar(textbox_select_mouseline) - idVar(tbx, start)) * lineheight;
			if (idReal(tbx, single_line) > 0)
			{
				a -= string_width(string_copy(idArr(tbx, line).Value(sVar(textbox_select_mouseline)), IntType(1), (IntType)(idVar(tbx, start))));
				b = IntType(0);
			}
			if (a >= IntType(0) && a <= w && b >= IntType(0) && b + lineheight <= h && mod((current_time() - sInt(textbox_marker)), IntType(1000)) < IntType(500))
			{
				draw_set_alpha(textnormala);
				draw_line_ext(textx + a, yy + b, textx + a, yy + b + lineheight, textnormal, IntType(1));
			}
		}
		draw_set_color(c_white);
		draw_set_alpha(prevalpha);
		if (sVar(window_focus) == string(tbx))
			sVar(textbox_lastfocus) = tbx;
		else
			if (sVar(window_focus) == /*""*/ STR(0))
				sVar(textbox_lastfocus) = -IntType(1);
		
		if (mouseover)
		{
			sVar(textbox_mouseover) = tbx;
			sInt(mouse_cursor) = cr_beam;
		}
		else
			if (sVar(textbox_mouseover) == tbx)
			{
				sVar(textbox_mouseover) = -IntType(1);
				sInt(mouse_cursor) = cr_default;
			}
		
		idVar(tbx, last_text) = idVar(tbx, text);
		idVar(tbx, last_width) = w;
		if (sVar(textbox_jumpto) == tbx)
			sVar(textbox_jumpto) = -IntType(1);
		return (inserttext != /*""*/ STR(0) || deletetext != IntType(0));
	}
	
}
