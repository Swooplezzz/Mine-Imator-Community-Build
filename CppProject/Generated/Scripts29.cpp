/*
	NOTE:
	This file was autogenerated by CppGen, changes may be overwritten and forever lost!
	Modify at your own risk!
	
	[ Generated on 2023.10.16 22:12:03 ]
*/

#include "Scripts.hpp"

namespace CppProject
{
	void execute(VarType file, VarType parameters, VarType wait)
	{
		log({ /*"execute"*/ STR(1119), file, parameters, wait });
		lib_execute(file, parameters, wait);
	}
	
	void export_done_image(ScopeAny self)
	{
		render_free();
		surface_free((IntType)(sVar(export_surface)));
		sVar(export_surface) = null_;
		sStr(window_state) = /*""*/ STR(0);
		global::render_watermark = false;
		global::render_background = true;
		global::render_hidden = false;
		toast_new(self, e_toast_POSITIVE, text_get({ /*"alertexportimage"*/ STR(1120) }));
		toast_add_action(self, /*"alertexportimageview"*/ STR(1121), ID_popup_open_url, sStr(export_filename));
	}
	
	void export_done_movie(ScopeAny self, BoolType cancel)
	{
		VarType fn;
		render_free();
		if (sStr(exportmovie_format) != /*"png"*/ STR(60))
		{
			movie_done();
			buffer_delete(sInt(exportmovie_buffer));
		}
		surface_free((IntType)(sVar(export_surface)));
		sVar(export_surface) = null_;
		sStr(window_state) = /*""*/ STR(0);
		global::render_watermark = false;
		global::render_background = true;
		global::render_hidden = false;
		sVar(timeline_marker) = sVar(exportmovie_marker_previous);
		if (sStr(exportmovie_format) == /*"png"*/ STR(60))
			fn = filename_new_ext(sStr(export_filename), /*""*/ STR(0)) + /*"_1.png"*/ STR(1122);
		else
			fn = sStr(export_filename);
		
		if (!cancel)
		{
			toast_new(self, e_toast_POSITIVE, text_get({ /*"alertexportmovie"*/ STR(1123) }));
			toast_add_action(self, /*"alertexportmovieview"*/ STR(1124), ID_popup_open_url, fn);
		}
	}
	
	RealType export_update(ScopeAny self)
	{
		if (keyboard_check(vk_escape) && sInt(export_escape_time) == IntType(0))
			sInt(export_escape_time) = current_time();
		if (sInt(export_escape_time) > IntType(0) && current_time() - sInt(export_escape_time) > IntType(1000))
		{
			sInt(export_escape_time) = IntType(0);
			if (question(text_get({ /*"questionstoprender"*/ STR(1125) })))
			{
				if (sStr(window_state) == /*"export_movie"*/ STR(49))
					export_done_movie(self, true);
				else
					if (sStr(window_state) == /*"export_image"*/ STR(56))
					{
						surface_save_lib(sVar(export_surface), sStr(export_filename));
						export_done_image(self);
					}
				
				return IntType(0);
			}
		}
		if (sStr(window_state) == /*"export_movie"*/ STR(49))
		{
			if (global::render_samples == -IntType(1))
			{
				sVar(timeline_marker) = sVar(exportmovie_marker_start) + (sReal(exportmovie_frame) / ObjType(obj_popup, sInt(popup_exportmovie))->framespersecond) * sVar(project_tempo);
				if (sVar(timeline_marker) > sVar(exportmovie_marker_end))
				{
					export_done_movie(self);
					return IntType(0);
				}
				app_update_animate(self);
			}
		}
		if (sStr(window_state) == /*"export_image"*/ STR(56))
			app_update_cameras(ObjType(obj_popup, sInt(popup_exportimage))->high_quality, false);
		if (sStr(window_state) == /*"export_movie"*/ STR(49))
		{
			global::render_active = /*"movie"*/ STR(1126);
			global::render_quality = ((sReal(exportmovie_high_quality) > 0) ? e_view_mode_RENDER : e_view_mode_SHADED);
		}
		else
		{
			global::render_active = /*"image"*/ STR(91);
			global::render_quality = ((ObjType(obj_popup, sInt(popup_exportimage))->high_quality > 0) ? e_view_mode_RENDER : e_view_mode_SHADED);
		}
		
		if (sStr(window_state) == /*"export_movie"*/ STR(49) && sStr(exportmovie_format) == /*"png"*/ STR(60))
			render_start({ sVar(export_surface), sInt(timeline_camera) });
		else
			render_start({ sVar(export_surface), sInt(timeline_camera), sVar(project_video_width), sVar(project_video_height) });
		
		if (global::render_quality == e_view_mode_RENDER)
			render_high(self);
		else
		{
			render_low(self);
			global::render_samples_done = true;
		}
		
		sVar(export_surface) = render_done();
		sReal(export_sample)++;
		if (global::render_quality == e_view_mode_RENDER && global::render_samples == global::_app->project_render_samples)
			global::render_samples_done = true;
		if (!global::render_samples_done)
			return IntType(1);
		global::render_active = null_;
		global::render_samples = -IntType(1);
		if (sStr(window_state) == /*"export_movie"*/ STR(49))
		{
			if (sStr(exportmovie_format) == /*"png"*/ STR(60))
			{
				RealType totalframes = ceil(((sVar(exportmovie_marker_end) - sVar(exportmovie_marker_start)) / sVar(project_tempo)) * ObjType(obj_popup, sInt(popup_exportmovie))->framespersecond);
				IntType totallen = string_length(string(totalframes));
				StringType numstr = string(sReal(exportmovie_frame) + IntType(1));
				numstr = string_repeat(/*"0"*/ STR(1063), (IntType)((totallen - string_length(numstr)))) + numstr;
				surface_save_lib(sVar(export_surface), filename_new_ext(sStr(export_filename), /*""*/ STR(0)) + /*"_"*/ STR(1127) + numstr + /*".png"*/ STR(6));
			}
			else
			{
				if (!is_cpp())
				{
					buffer_get_surface(sInt(exportmovie_buffer), (IntType)(sVar(export_surface)), IntType(0));
					buffer_save(sInt(exportmovie_buffer), temp_file);
				}
				VarType err = movie_frame(temp_file);
				if (err < IntType(0))
				{
					export_done_movie(self);
					log({ /*"Error when adding frame, error code"*/ STR(1128), err });
					error(/*"errorexportmovie"*/ STR(68));
					return IntType(0);
				}
			}
			
			sReal(exportmovie_frame)++;
			global::current_step += round(60.0 / ObjType(obj_popup, sInt(popup_exportmovie))->framespersecond);
		}
		if (sStr(window_state) == /*"export_image"*/ STR(56))
		{
			surface_save_lib(sVar(export_surface), sStr(export_filename));
			export_done_image(self);
		}
		return IntType(1);
	}
	
	StringType filename_get_unique(StringType fn)
	{
		IntType num;
		StringType newfn, path, ext;
		VarType noext;
		num = IntType(2);
		newfn = fn;
		path = filename_dir(fn) + /*"/"*/ STR(16);
		noext = filename_new_ext(filename_name(fn), /*""*/ STR(0));
		ext = filename_ext(filename_name(fn));
		while (file_exists_lib(newfn))
			newfn = path + noext + /*" ("*/ STR(1129) + string(num++) + /*")"*/ STR(1105) + ext;
		
		return newfn;
	}
	
	VarType filename_get_valid(VarType fn)
	{
		fn = string_replace_all(fn, /*"/"*/ STR(16), /*"_"*/ STR(1127));
		fn = string_replace_all(fn, /*"\\"*/ STR(1130), /*"_"*/ STR(1127));
		fn = string_replace_all(fn, /*":"*/ STR(783), /*"_"*/ STR(1127));
		fn = string_replace_all(fn, /*"*"*/ STR(1108), /*"_"*/ STR(1127));
		fn = string_replace_all(fn, /*"?"*/ STR(1131), /*"_"*/ STR(1127));
		fn = string_replace_all(fn, /*"\""*/ STR(1132), /*"_"*/ STR(1127));
		fn = string_replace_all(fn, /*"<"*/ STR(1133), /*"_"*/ STR(1127));
		fn = string_replace_all(fn, /*">"*/ STR(1134), /*"_"*/ STR(1127));
		fn = string_replace_all(fn, /*"|"*/ STR(880), /*"_"*/ STR(1127));
		while (string_char_at(fn, string_length(fn)) == /*" "*/ STR(17))
			fn = string_copy(fn, IntType(1), (IntType)(string_length(fn) - IntType(1)));
		
		return fn;
	}
	
	VarType filename_new_ext(VarType fn, StringType newext)
	{
		IntType p;
		for (p = string_length(fn); p >= IntType(0); p--)
		{
			StringType c = string_char_at(fn, p);
			if (p == IntType(0) || c == /*"\\"*/ STR(1130) || c == /*"/"*/ STR(16))
				return fn + newext;
			if (c == /*"."*/ STR(1104))
				break;
		}
		return string_copy(fn, IntType(1), (IntType)(p - IntType(1))) + newext;
	}
	
	RealType file_copy_lib(VarType src, VarType dest)
	{
		if (src == dest)
			return IntType(0);
		return lib_file_copy(src, dest);
	}
	
	VarType file_delete_lib(StringType fn)
	{
		return lib_file_delete(fn);
	}
	
	StringType file_dialog_open(VarType filter, StringType filename, StringType directory, VarType title)
	{
		return string(get_open_filename_ext(filter, filename, directory, title));
	}
	
	StringType file_dialog_open_asset()
	{
		return file_dialog_open_multiple(text_get({ /*"filedialogopenasset"*/ STR(1135) }) + /*"|"*/ STR(880) + asset_exts, /*""*/ STR(0), /*""*/ STR(0), text_get({ /*"filedialogopenassetcaption"*/ STR(1136) }));
	}
	
	StringType file_dialog_open_font()
	{
		return file_dialog_open(text_get({ /*"filedialogopenfont"*/ STR(1137) }) + /*" (*.ttf)|*.ttf"*/ STR(1138), /*""*/ STR(0), /*""*/ STR(0), text_get({ /*"filedialogopenfontcaption"*/ STR(1139) }));
	}
	
	StringType file_dialog_open_image()
	{
		return file_dialog_open(text_get({ /*"filedialogopenimage"*/ STR(1140) }) + /*" (*.png; *.jpg)|*.png;*.jpg;*.jpeg;"*/ STR(1141), /*""*/ STR(0), /*""*/ STR(0), text_get({ /*"filedialogopenimagecaption"*/ STR(1142) }));
	}
	
	StringType file_dialog_open_image_pack()
	{
		return file_dialog_open(text_get({ /*"filedialogopenimageorpack"*/ STR(1143) }) + /*" (*.png; *.jpg; *.zip)|*.png;*.jpg;*.jpeg;*.zip"*/ STR(1144), /*""*/ STR(0), /*""*/ STR(0), text_get({ /*"filedialogopenimageorpackcaption"*/ STR(1145) }));
	}
	
	StringType file_dialog_open_language()
	{
		return file_dialog_open(text_get({ /*"filedialogopenlanguage"*/ STR(1146) }) + /*" (*.milanguage;*.txt)|*.milanguage;*.txt"*/ STR(1147), /*""*/ STR(0), languages_directory, text_get({ /*"filedialogopenlanguagecaption"*/ STR(1148) }));
	}
	
	StringType file_dialog_open_model()
	{
		return file_dialog_open(text_get({ /*"filedialogopenmodel"*/ STR(1149) }) + /*" (*.mimodel;*.json;*.zip)|*.mimodel;*.json;*.zip"*/ STR(1150), /*""*/ STR(0), /*""*/ STR(0), text_get({ /*"filedialogopenmodelcaption"*/ STR(1151) }));
	}
	
	StringType file_dialog_open_multiple(VarType filter, StringType filename, StringType directory, VarType title)
	{
		return string(get_open_filename_ext(filter, filename, directory, title));
	}
	
	StringType file_dialog_open_pack()
	{
		return file_dialog_open(text_get({ /*"filedialogopenpack"*/ STR(1152) }) + /*" (*.zip)|*.zip"*/ STR(1153), /*""*/ STR(0), /*""*/ STR(0), text_get({ /*"filedialogopenpackcaption"*/ STR(1154) }));
	}
	
	StringType file_dialog_open_particles()
	{
		return file_dialog_open(text_get({ /*"filedialogopenparticles"*/ STR(1155) }) + /*" (*.miparticles; *.zip; *.particles)|*miparticles;*.zip;*.particles;"*/ STR(1156), /*""*/ STR(0), particles_directory, text_get({ /*"filedialogopenparticlecaption"*/ STR(1157) }));
	}
	
	VarType file_dialog_open_project(ScopeAny self)
	{
		return file_dialog_open(text_get({ /*"filedialogopenproject"*/ STR(1158) }) + /*" (*.miproject; *.zip; *.mproj; *.mani)|*miproject;*.zip;*.mproj;*.mani|"*/ STR(1159) + text_get({ /*"filedialogopenbackup"*/ STR(1160) }) + /*" (*.backup*; *.mbackup*)|*.backup*;*.mbackup*"*/ STR(1161), /*""*/ STR(0), sStr(setting_project_folder), text_get({ /*"filedialogopenprojectcaption"*/ STR(1162) }));
	}
	
	StringType file_dialog_open_render()
	{
		return file_dialog_open(text_get({ /*"filedialogopenrender"*/ STR(1163) }) + /*" (*.mirender)|*mirender"*/ STR(1164), /*""*/ STR(0), /*""*/ STR(0), text_get({ /*"filedialogopenrendercaption"*/ STR(1165) }));
	}
	
	StringType file_dialog_open_scenery()
	{
		return file_dialog_open(text_get({ /*"filedialogopenscenery"*/ STR(1166) }) + /*" (*.schematic; *.nbt; *.blocks)|*.schematic;*.nbt;*.blocks"*/ STR(1167), /*""*/ STR(0), schematics_directory, text_get({ /*"filedialogopenscenerycaption"*/ STR(1168) }));
	}
	
	StringType file_dialog_open_sound()
	{
		return file_dialog_open(text_get({ /*"filedialogopensound"*/ STR(1169) }) + /*" (*.mp3; *.wav; *.ogg; *.flac; *.wma; *.m4a)|*.mp3;*.wav;*.ogg;*.flac;*.wma;*.m4a;"*/ STR(1170), /*""*/ STR(0), /*""*/ STR(0), text_get({ /*"filedialogopensoundcaption"*/ STR(1171) }));
	}
	
	StringType file_dialog_save(VarType filter, VarType filename, StringType directory, VarType title)
	{
		return string(get_save_filename_ext(filter, filename, directory, title));
	}
	
	StringType file_dialog_save_image(VarType fn)
	{
		return file_dialog_save(text_get({ /*"filedialogsaveimage"*/ STR(1172) }) + /*" (*.png)|*.png"*/ STR(1173), filename_get_valid(fn), /*""*/ STR(0), text_get({ /*"filedialogsaveimagecaption"*/ STR(1174) }));
	}
	
	StringType file_dialog_save_keyframes(VarType fn)
	{
		return file_dialog_save(text_get({ /*"filedialogsavekeyframes"*/ STR(1175) }) + /*" (*.miframes)|*.miframes"*/ STR(1176), filename_get_valid(fn), /*""*/ STR(0), text_get({ /*"filedialogsavekeyframescaption"*/ STR(1177) }));
	}
	
	StringType file_dialog_save_movie_mov(ScopeAny self, VarType fn)
	{
		return file_dialog_save(text_get({ /*"filedialogsavemoviemov"*/ STR(1178) }) + /*" (*.mov)|*.mov"*/ STR(1179), filename_get_valid(fn), sStr(project_folder), text_get({ /*"filedialogsavemoviecaption"*/ STR(1180) }));
	}
	
	StringType file_dialog_save_movie_mp4(ScopeAny self, VarType fn)
	{
		return file_dialog_save(text_get({ /*"filedialogsavemoviemp4"*/ STR(1181) }) + /*" (*.mp4)|*.mp4"*/ STR(1182), filename_get_valid(fn), sStr(project_folder), text_get({ /*"filedialogsavemoviecaption"*/ STR(1180) }));
	}
	
	StringType file_dialog_save_movie_png(ScopeAny self, VarType fn)
	{
		return file_dialog_save(text_get({ /*"filedialogsavemoviepng"*/ STR(1183) }) + /*" (*.png)|*.png"*/ STR(1173), filename_get_valid(fn), sStr(project_folder), text_get({ /*"filedialogsavemoviecaption"*/ STR(1180) }));
	}
	
	StringType file_dialog_save_movie_wmv(ScopeAny self, VarType fn)
	{
		return file_dialog_save(text_get({ /*"filedialogsavemoviewmv"*/ STR(1184) }) + /*" (*.wmv)|*.wmv"*/ STR(1185), filename_get_valid(fn), sStr(project_folder), text_get({ /*"filedialogsavemoviecaption"*/ STR(1180) }));
	}
	
	StringType file_dialog_save_object(VarType fn)
	{
		return file_dialog_save(text_get({ /*"filedialogsaveobject"*/ STR(1186) }) + /*" (*.miobject)|*.miobject"*/ STR(1187), filename_get_valid(fn), /*""*/ STR(0), text_get({ /*"filedialogsaveobjectcaption"*/ STR(1188) }));
	}
	
	StringType file_dialog_save_particles(VarType fn)
	{
		return file_dialog_save(text_get({ /*"filedialogsaveparticles"*/ STR(1189) }) + /*" (*.miparticles)|*.miparticles"*/ STR(1190), filename_get_valid(fn), particles_directory, text_get({ /*"filedialogsaveparticlescaption"*/ STR(1191) }));
	}
	
	StringType file_dialog_save_project(ScopeAny self, VarType fn)
	{
		return file_dialog_save(/*""*/ STR(0), fn, sStr(setting_project_folder), text_get({ /*"filedialogsaveprojectcaption"*/ STR(1192) }));
	}
	
	StringType file_dialog_save_render(StringType fn)
	{
		return file_dialog_save(text_get({ /*"filedialogsaverender"*/ STR(1193) }) + /*" (*.mirender)|*.mirender"*/ STR(1194), filename_get_valid(fn), render_directory, text_get({ /*"filedialogsaverendercaption"*/ STR(1195) }));
	}
	
	StringType file_dialog_save_resource(VarType fn, StringType exts)
	{
		return file_dialog_save(/*" * "*/ STR(701) + exts + /*"|*"*/ STR(1196) + exts, filename_get_valid(fn), /*""*/ STR(0), text_get({ /*"filedialogsaveresourcecaption"*/ STR(1197) }));
	}
	
	RealType file_exists_lib(VarType fn)
	{
		if (fn == /*""*/ STR(0))
			return IntType(0);
		return lib_file_exists(fn);
	}
	
	ArrType file_find(StringType dir, StringType exts)
	{
		ArrType ret;
		StringType f;
		ret = ArrType();
		f = file_find_first(dir + /*"*"*/ STR(1108), IntType(0));
		while (f != /*""*/ STR(0))
		{
			if (string_contains(exts, filename_ext(f)))
				ret[array_length(VarType::CreateRef(ret))] = dir + f;
			f = file_find_next();
		}
		
		file_find_close();
		return ret;
	}
	
	StringType file_find_single(StringType dir, StringType exts)
	{
		ArrType ret = file_find(dir, exts);
		if (array_length(VarType::CreateRef(ret)) > IntType(0))
			return ret.Value(IntType(0));
		else
			return /*""*/ STR(0);
		
		return "";
	}
	
	BoolType file_lib_startup()
	{
		log({ /*"working_directory"*/ STR(1198), gmlGlobal::working_directory });
		if (!directory_exists_lib(gmlGlobal::working_directory))
		{
			log({ /*"directory broken"*/ STR(1199) });
			access_error();
			return false;
		}
		IntType surf;
		StringType tmpfile1, tmpfile2;
		surf = surface_create(IntType(32), IntType(32));
		tmpfile1 = file_directory + /*"tmp.png"*/ STR(1200);
		tmpfile2 = data_directory + /*"tmp.png"*/ STR(1200);
		log({ /*"Trying to save files"*/ STR(1201) });
		file_delete_lib(tmpfile1);
		file_delete_lib(tmpfile2);
		surface_save(surf, tmpfile1);
		file_copy_lib(tmpfile1, tmpfile2);
		surface_free(surf);
		if (!file_exists_lib(tmpfile1))
		{
			log({ /*"Couldn't save to file_directory"*/ STR(1202) });
			access_error();
			return false;
		}
		if (!file_exists_lib(tmpfile2))
		{
			log({ /*"Couldn't save to data_directory"*/ STR(1203) });
			access_error();
			return false;
		}
		log({ /*"surface_save OK"*/ STR(1204) });
		IntType tex1, tex2;
		tex1 = texture_create(tmpfile1);
		tex2 = texture_create(tmpfile2);
		if (tex1 < IntType(0) || texture_width(tex1) != IntType(32) || texture_height(tex1) != IntType(32))
		{
			log({ /*"Couldn't load texture from file_directory"*/ STR(1205) });
			access_error();
			return false;
		}
		if (tex2 < IntType(0) || texture_width(tex2) != IntType(32) || texture_height(tex2) != IntType(32))
		{
			log({ /*"Couldn't load texture from data_directory"*/ STR(1206) });
			access_error();
			return false;
		}
		log({ /*"texture_create OK"*/ STR(1207) });
		file_delete_lib(tmpfile1);
		file_delete_lib(tmpfile2);
		if (file_exists_lib(tmpfile1))
		{
			log({ /*"Couldn't delete from file_directory"*/ STR(1208) });
			access_error();
			return false;
		}
		if (file_exists_lib(tmpfile1))
		{
			log({ /*"Couldn't delete from data_directory"*/ STR(1209) });
			access_error();
			return false;
		}
		log({ /*"file_delete_lib OK"*/ STR(1210) });
		return true;
	}
	
	RealType file_rename_lib(VarType oldname, VarType newname)
	{
		if (oldname == /*""*/ STR(0) || oldname == newname)
			return IntType(0);
		return lib_file_rename(oldname, newname);
	}
	
	StringType file_text_contents(StringType fname)
	{
		StringType str;
		IntType line;
		str = /*""*/ STR(0);
		line = IntType(0);
		if (file_exists_lib(fname))
		{
			file_delete_lib(temp_file);
			file_copy_lib(fname, temp_file);
			IntType f = file_text_open_read(temp_file);
			if (f > -IntType(1))
			{
				while (!file_text_eof(f))
				{
					if (line++ > IntType(0))
						str += /*"\n"*/ STR(72);
					str += file_text_read_string(f);
					file_text_readln(f);
				}
				
				file_text_close(f);
			}
		}
		return str;
	}
	
	IntType find_biome(VarType biomename)
	{
		IntType biome = null_;
		for (IntType i = IntType(0); i < IntType(5) && ds_map_exists(global::legacy_biomes_map, biomename); i++)
			biomename = DsMap(global::legacy_biomes_map).Value(biomename);
		withAll (obj_biome, noone)
		{
			if (self->name == biomename)
			{
				biome = self->id;
				break;
			}
		}
		
		return biome;
	}
	
	IntType find_videoquality(RealType bitrate)
	{
		withAll (obj_videoquality, noone)
			if (self->bit_rate == bitrate)
				return self->id;
		
		return null_;
	}
	
	VarType find_videotemplate(VarType w, VarType h)
	{
		withAll (obj_videotemplate, noone)
			if (self->width == w && self->height == h)
				return self->id;
		
		return IntType(0);
	}
	
	IntType font_add_lib(StringType fname, IntType size, BoolType bold, BoolType italic, BoolType aa)
	{
		StringType tmpfile = file_directory + /*"tmp.ttf"*/ STR(1211);
		file_copy_lib(fname, tmpfile);
		if (file_exists_lib(tmpfile))
		{
			font_add_enable_aa(aa);
			IntType fnt = font_add(tmpfile, size, bold, italic, IntType(32), IntType(1024));
			font_add_enable_aa(true);
			if (font_exists(fnt))
				return fnt;
		}
		return null_;
	}
	
	VarType gzunzip(StringType src, StringType dest)
	{
		return lib_gzunzip(src, dest);
	}
	
	RealType halton(RealType i, RealType xx)
	{
		RealType f, r;
		f = IntType(1);
		r = IntType(0);
		while (i > IntType(0))
		{
			f /= xx;
			r = r + f * (mod(i, xx));
			i = floor(i / xx);
		}
		
		return r;
	}
	
	IntType hex_to_color(VarType oldstr)
	{
		StringType str, hex;
		str = string_replace(oldstr, /*"#"*/ STR(855), /*""*/ STR(0));
		str = string_upper(str + string_repeat(/*"0"*/ STR(1063), (IntType)(IntType(6) - string_length(oldstr))));
		hex = /*"0123456789ABCDEF"*/ STR(1038);
		return make_color_rgb((IntType)(string_pos(string_char_at(str, IntType(1)), hex) * IntType(16) + string_pos(string_char_at(str, IntType(2)), hex) - IntType(17)), (IntType)(string_pos(string_char_at(str, IntType(3)), hex) * IntType(16) + string_pos(string_char_at(str, IntType(4)), hex) - IntType(17)), (IntType)(string_pos(string_char_at(str, IntType(5)), hex) * IntType(16) + string_pos(string_char_at(str, IntType(6)), hex) - IntType(17)));
	}
	
	RealType hex_to_dec(StringType hex)
	{
		RealType dec;
		StringType h;
		IntType p;
		hex = string_upper(hex);
		dec = IntType(0);
		h = /*"0123456789ABCDEF"*/ STR(1038);
		for (p = IntType(1); p <= string_length(hex); p++)
			dec = (IntType)dec << (IntType)(IntType)IntType(4) | (IntType)(string_pos(string_char_at(hex, p), h) - IntType(1));
		return dec;
	}
	
	void history_clear(ScopeAny self)
	{
		sReal(history_amount) = IntType(0);
		sReal(history_pos) = IntType(0);
		withAll (obj_history, self->id)
			instance_destroy(ScopeAny(self));
		
		withAll (obj_history_save, self->id)
			instance_destroy(ScopeAny(self));
		
	}
	
	void history_copy_render_settings(ScopeAny self, IntType obj)
	{
		sVar(project_render_samples) = idVar(obj, project_render_samples);
		sVar(project_render_ssao) = idVar(obj, project_render_ssao);
		sVar(project_render_ssao_radius) = idVar(obj, project_render_ssao_radius);
		sVar(project_render_ssao_power) = idVar(obj, project_render_ssao_power);
		sVar(project_render_ssao_color) = idVar(obj, project_render_ssao_color);
		sVar(project_render_shadows) = idVar(obj, project_render_shadows);
		sVar(project_render_shadows_sun_buffer_size) = idVar(obj, project_render_shadows_sun_buffer_size);
		sVar(project_render_shadows_spot_buffer_size) = idVar(obj, project_render_shadows_spot_buffer_size);
		sVar(project_render_shadows_point_buffer_size) = idVar(obj, project_render_shadows_point_buffer_size);
		sVar(project_render_shadows_transparent) = idVar(obj, project_render_shadows_transparent);
		sVar(project_render_subsurface_samples) = idVar(obj, project_render_subsurface_samples);
		sVar(project_render_subsurface_highlight) = idVar(obj, project_render_subsurface_highlight);
		sVar(project_render_subsurface_highlight_strength) = idVar(obj, project_render_subsurface_highlight);
		sVar(project_render_indirect) = idVar(obj, project_render_indirect);
		sVar(project_render_indirect_precision) = idVar(obj, project_render_indirect_precision);
		sVar(project_render_indirect_blur_radius) = idVar(obj, project_render_indirect_blur_radius);
		sVar(project_render_indirect_strength) = idVar(obj, project_render_indirect_strength);
		sVar(project_render_reflections) = idVar(obj, project_render_reflections);
		sVar(project_render_reflections_precision) = idVar(obj, project_render_reflections_precision);
		sVar(project_render_reflections_thickness) = idVar(obj, project_render_reflections_thickness);
		sVar(project_render_reflections_fade_amount) = idVar(obj, project_render_reflections_fade_amount);
		sVar(project_render_glow) = idVar(obj, project_render_glow);
		sVar(project_render_glow_radius) = idVar(obj, project_render_glow_radius);
		sVar(project_render_glow_intensity) = idVar(obj, project_render_glow_intensity);
		sVar(project_render_glow_falloff) = idVar(obj, project_render_glow_falloff);
		sVar(project_render_glow_falloff_radius) = idVar(obj, project_render_glow_falloff_radius);
		sVar(project_render_glow_falloff_intensity) = idVar(obj, project_render_glow_falloff_intensity);
		sVar(project_render_aa) = idVar(obj, project_render_aa);
		sVar(project_render_aa_power) = idVar(obj, project_render_aa_power);
		sVar(project_render_texture_filtering) = idVar(obj, project_render_texture_filtering);
		sVar(project_render_transparent_block_texture_filtering) = idVar(obj, project_render_transparent_block_texture_filtering);
		sVar(project_render_texture_filtering_level) = idVar(obj, project_render_texture_filtering_level);
		sVar(project_bend_style) = idVar(obj, project_bend_style);
		sVar(project_render_opaque_leaves) = idVar(obj, project_render_opaque_leaves);
		sVar(project_render_liquid_animation) = idVar(obj, project_render_liquid_animation);
		sVar(project_render_water_reflections) = idVar(obj, project_render_water_reflections);
		sVar(project_render_block_emissive) = idVar(obj, project_render_block_emissive);
		sVar(project_render_block_subsurface) = idVar(obj, project_render_block_subsurface);
	}
	
	void history_destroy_loaded(Scope<obj_history> self)
	{
		for (IntType i = IntType(0); i < self->loaded_amount; i++)
		{
			withOne (Object, save_id_find(self->loaded_save_id.Value(i)), self->id)
			{
				if (self->subAssetId == ID_obj_resource && sBool(copied))
					file_delete_lib(global::_app->project_folder + /*"/"*/ STR(16) + sVar(filename));
				instance_destroy(self);
			}
			
		}
	}
	
	void history_pop(ScopeAny self)
	{
		sInt(project_changed) = true;
		action_tl_play_break(self);
		if (sReal(history_pos) > IntType(0))
		{
			sReal(history_amount) -= sReal(history_pos);
			for (IntType h = IntType(0); h < sReal(history_amount); h++)
			{
				if (h < sReal(history_pos))
				{
					withOne (obj_history, sArr(history).Value(h), self->id)
					{
						withAll (obj_history_save, self->id)
							if (self->hobj == self.otherId)
								instance_destroy(ScopeAny(self));
						
						instance_destroy(ScopeAny(self));
					}
					
				}
				sArr(history)[h] = sArr(history).Value(h + sReal(history_pos));
			}
		}
		sReal(history_pos) = IntType(0);
		global::render_samples = -IntType(1);
		sBool(history_resource_update) = true;
	}
	
	void history_push(ScopeAny self)
	{
		sReal(history_amount)++;
		for (RealType h = sReal(history_amount); h > IntType(0); h--)
			sArr(history)[h] = sArr(history).Value(h - IntType(1));
	}
	
	IntType history_redo_res(ScopeAny self)
	{
		IntType res;
		if (ObjType(obj_history, global::history_data)->filename != /*""*/ STR(0) && !ObjType(obj_history, global::history_data)->replaced)
		{
			res = new_res(self, ObjType(obj_history, global::history_data)->filename, ObjType(obj_history, global::history_data)->type);
			idVar(res, save_id) = ObjType(obj_history, global::history_data)->new_res_save_id;
			if (ObjType(obj_history, global::history_data)->type == e_res_type_SKIN)
				idVar(res, player_skin) = ObjType(obj_history, global::history_data)->player_skin;
			else
				if (ObjType(obj_history, global::history_data)->type == e_res_type_DOWNLOADED_SKIN)
					idVar(res, player_skin) = true;
				else
					if (ObjType(obj_history, global::history_data)->type == e_res_type_ITEM_SHEET)
						idVar(res, item_sheet_size) = array_copy_1d(ObjType(obj_history, global::history_data)->item_sheet_size);
			
			
			withOne (Object, res, self->id)
				res_load(self);
			
		}
		else
			res = save_id_find(ObjType(obj_history, global::history_data)->new_res_save_id);
		
		return res;
	}
	
	void history_restore_bench(ScopeAny self, IntType save)
	{
		withOne (obj_history_save, save, self->id)
			temp_copy(ScopeAny(self), global::_app->bench_settings);
		
		withOne (obj_bench_settings, sInt(bench_settings), self->id)
		{
			temp_find_save_ids(ScopeAny(self));
			temp_update(ScopeAny(self));
			global::temp_creator = global::_app->bench_settings;
			for (IntType t = IntType(0); t < ObjType(obj_history_save, save)->temp_amount; t++)
			{
				withOne (obj_history_save, ObjType(obj_history_save, save)->temp_save_obj.Value(t), self->id)
				{
					IntType ntemp = (new obj_template)->id;
					temp_copy(ScopeAny(self), ntemp);
					withOne (obj_template, ntemp, self->id)
					{
						self->save_id = ObjType(obj_history_save, self.otherId)->save_id;
						temp_find_save_ids(ScopeAny(self));
						temp_update(ScopeAny(self));
					}
					
				}
				
			}
			global::temp_creator = global::_app->id;
			if (self->type == e_temp_type_PARTICLE_SPAWNER)
			{
				temp_particles_type_clear(ScopeAny(self));
				for (IntType p = IntType(0); p < ObjType(obj_history_save, save)->pc_type_amount; p++)
					history_restore_ptype(ObjType(obj_history_save, save)->pc_type_save_obj.Value(p), self->id);
				temp_particles_restart(ScopeAny(self));
			}
		}
		
	}
	
	void history_restore_keyframes(Scope<obj_history> self)
	{
		for (IntType k = IntType(0); k < self->save_kf_amount; k++)
		{
			withOne (Object, save_id_find(self->save_kf_tl_save_id.Value(k)), self->id)
			{
				IntType kf = tl_keyframe_add(self, ObjType(obj_history, self.otherId)->save_kf_pos.Value(k));
				for (IntType v = IntType(0); v < e_value_amount; v++)
					ObjType(obj_keyframe, kf)->value[v] = tl_value_find_save_id(v, ObjType(obj_keyframe, kf)->value.Value(v), ObjType(obj_history, self.otherId)->save_kf_value[k][v]);
			}
			
		}
	}
	
	void history_restore_parts(Scope<obj_history> self)
	{
		for (IntType t = IntType(0); t < self->part_amount; t++)
		{
			IntType tl = history_restore_tl(self->part_save_obj.Value(t));
			ds_list_add({ idInt(ObjType(obj_timeline, tl)->part_of, part_list), tl });
		}
		for (IntType m = IntType(0); m < self->part_child_amount; m++)
			withOne (Object, save_id_find(self->part_child_save_id.Value(m)), self->id)
				tl_set_parent(self, { save_id_find(ObjType(obj_history, global::history_data)->part_child_parent_save_id.Value(m)), ObjType(obj_history, global::history_data)->part_child_parent_tree_index.Value(m) });
		
		history_restore_tl_select(self);
		if (self->part_amount > IntType(0))
			history_restore_part_usage_tl(global::history_data);
	}
	
	void history_restore_part_usage_tl(VarType hobj)
	{
		IntType tl;
		VarType kfindex;
		withOne (obj_history, hobj, noone)
		{
			for (IntType i = IntType(0); i < self->usage_tl_attractor_amount; i++)
			{
				tl = save_id_find(self->usage_tl_attractor_save_id.Value(i));
				idVar(tl, value)[e_value_ATTRACTOR] = save_id_find(self->usage_tl_attractor_part_save_id.Value(i));
			}
			for (IntType i = IntType(0); i < self->usage_tl_ik_target_amount; i++)
			{
				tl = save_id_find(self->usage_tl_ik_target_save_id.Value(i));
				idVar(tl, value)[e_value_IK_TARGET] = save_id_find(self->usage_tl_ik_target_part_save_id.Value(i));
			}
			for (IntType i = IntType(0); i < self->usage_tl_flw_rot_target_amount; i++)
			{
				tl = save_id_find(self->usage_tl_flw_rot_target_save_id.Value(i));
				idVar(tl, value)[e_value_ROT_TARGET] = save_id_find(self->usage_tl_flw_rot_target_part_save_id.Value(i));
			}
			for (IntType i = IntType(0); i < self->usage_tl_ik_target_angle_amount; i++)
			{
				tl = save_id_find(self->usage_tl_ik_target_angle_save_id.Value(i));
				idVar(tl, value)[e_value_IK_TARGET_ANGLE] = save_id_find(self->usage_tl_ik_target_angle_part_save_id.Value(i));
			}
			for (IntType i = IntType(0); i < self->usage_kf_attractor_amount; i++)
			{
				tl = save_id_find(self->usage_kf_attractor_tl_save_id.Value(i));
				kfindex = self->usage_kf_attractor_index.Value(i);
				ObjType(obj_keyframe, DsList(idInt(tl, keyframe_list))[kfindex])->value[e_value_ATTRACTOR] = save_id_find(self->usage_kf_attractor_tl_part_save_id.Value(i));
			}
			for (IntType i = IntType(0); i < self->usage_kf_ik_target_amount; i++)
			{
				tl = save_id_find(self->usage_kf_ik_target_tl_save_id.Value(i));
				kfindex = self->usage_kf_ik_target_index.Value(i);
				ObjType(obj_keyframe, DsList(idInt(tl, keyframe_list))[kfindex])->value[e_value_IK_TARGET] = save_id_find(self->usage_kf_ik_target_tl_part_save_id.Value(i));
			}
			for (IntType i = IntType(0); i < self->usage_kf_flw_rot_target_amount; i++)
			{
				tl = save_id_find(self->usage_kf_flw_rot_target_tl_save_id.Value(i));
				kfindex = self->usage_kf_flw_rot_target_index.Value(i);
				ObjType(obj_keyframe, DsList(idInt(tl, keyframe_list))[kfindex])->value[e_value_ROT_TARGET] = save_id_find(self->usage_kf_flw_rot_target_tl_part_save_id.Value(i));
			}
			for (IntType i = IntType(0); i < self->usage_kf_flw_pos_target_amount; i++)
			{
				tl = save_id_find(self->usage_kf_flw_pos_target_tl_save_id.Value(i));
				kfindex = self->usage_kf_flw_pos_target_index.Value(i);
				ObjType(obj_keyframe, DsList(idInt(tl, keyframe_list))[kfindex])->value[e_value_POS_TARGET] = save_id_find(self->usage_kf_flw_pos_target_tl_part_save_id.Value(i));
			}
			for (IntType i = IntType(0); i < self->usage_kf_flw_scale_target_amount; i++)
			{
				tl = save_id_find(self->usage_kf_flw_scale_target_tl_save_id.Value(i));
				kfindex = self->usage_kf_flw_scale_target_index.Value(i);
				ObjType(obj_keyframe, DsList(idInt(tl, keyframe_list))[kfindex])->value[e_value_SCALE_TARGET] = save_id_find(self->usage_kf_flw_scale_target_tl_part_save_id.Value(i));
			}
			for (IntType i = IntType(0); i < self->usage_kf_ik_target_angle_amount; i++)
			{
				tl = save_id_find(self->usage_kf_ik_target_angle_tl_save_id.Value(i));
				kfindex = self->usage_kf_ik_target_angle_index.Value(i);
				ObjType(obj_keyframe, DsList(idInt(tl, keyframe_list))[kfindex])->value[e_value_IK_TARGET_ANGLE] = save_id_find(self->usage_kf_ik_target_tl_part_save_id.Value(i));
			}
		}
		
	}
	
	IntType history_restore_ptype(VarType save, VarType creator)
	{
		IntType ptype;
		ptype = (new obj_particle_type)->id;
		global::save_id_seed--;
		withOne (obj_history_save, save, noone)
			ptype_copy(ScopeAny(self), ptype);
		
		withOne (obj_particle_type, ptype, noone)
		{
			self->save_id = ObjType(obj_history_save, save)->save_id;
			ptype_find_save_ids(self);
			ObjType(obj_particle_type, self->id)->creator = creator;
			ds_list_insert(idInt(ObjType(obj_particle_type, self->id)->creator, pc_type_list), self->creator_index, self->id);
			idInt(self->sprite_tex, count)++;
			idInt(self->sprite_template_tex, count)++;
			ptype_update_sprite_vbuffers(ScopeAny(self));
		}
		
		return ptype;
	}
	
	IntType history_restore_res(IntType save)
	{
		IntType res;
		res = (new obj_resource)->id;
		withOne (obj_history_save, save, noone)
			res_copy(ScopeAny(self), res);
		
		global::save_folder = global::_app->project_folder;
		global::load_folder = global::_app->project_folder;
		withOne (obj_resource, res, noone)
		{
			self->save_id = ObjType(obj_history_save, save)->save_id;
			res_load(ScopeAny(self));
			for (IntType s = IntType(0); s < ObjType(obj_history_save, save)->usage_model_amount; s++)
			{
				withOne (Object, save_id_find(ObjType(obj_history_save, save)->usage_model_save_id.Value(s)), self->id)
				{
					if (sVar(model) != null_)
						idInt(sVar(model), count)--;
					sVar(model) = res;
				}
				
			}
			for (IntType s = IntType(0); s < ObjType(obj_history_save, save)->usage_model_tex_amount; s++)
			{
				withOne (Object, save_id_find(ObjType(obj_history_save, save)->usage_model_tex_save_id.Value(s)), self->id)
				{
					idInt(sVar(model_tex), count)--;
					sVar(model_tex) = res;
				}
				
			}
			for (IntType s = IntType(0); s < ObjType(obj_history_save, save)->usage_model_tex_material_amount; s++)
			{
				withOne (Object, save_id_find(ObjType(obj_history_save, save)->usage_model_tex_material_save_id.Value(s)), self->id)
				{
					idInt(sVar(model_tex_material), count)--;
					sVar(model_tex_material) = res;
				}
				
			}
			for (IntType s = IntType(0); s < ObjType(obj_history_save, save)->usage_model_tex_normal_amount; s++)
			{
				withOne (Object, save_id_find(ObjType(obj_history_save, save)->usage_model_tex_normal_save_id.Value(s)), self->id)
				{
					idInt(sVar(model_tex_normal), count)--;
					sVar(model_tex_normal) = res;
				}
				
			}
			for (IntType s = IntType(0); s < ObjType(obj_history_save, save)->usage_item_tex_amount; s++)
			{
				withOne (Object, save_id_find(ObjType(obj_history_save, save)->usage_item_tex_save_id.Value(s)), self->id)
				{
					idInt(sVar(item_tex), count)--;
					sVar(item_tex) = res;
					render_generate_item(self);
				}
				
			}
			for (IntType s = IntType(0); s < ObjType(obj_history_save, save)->usage_item_tex_material_amount; s++)
			{
				withOne (Object, save_id_find(ObjType(obj_history_save, save)->usage_item_tex_material_save_id.Value(s)), self->id)
				{
					idInt(sVar(item_tex_material), count)--;
					sVar(item_tex_material) = res;
					render_generate_item(self);
				}
				
			}
			for (IntType s = IntType(0); s < ObjType(obj_history_save, save)->usage_item_tex_normal_amount; s++)
			{
				withOne (Object, save_id_find(ObjType(obj_history_save, save)->usage_item_tex_normal_save_id.Value(s)), self->id)
				{
					idInt(sVar(item_tex_normal), count)--;
					sVar(item_tex_normal) = res;
					render_generate_item(self);
				}
				
			}
			for (IntType s = IntType(0); s < ObjType(obj_history_save, save)->usage_block_tex_amount; s++)
			{
				withOne (Object, save_id_find(ObjType(obj_history_save, save)->usage_block_tex_save_id.Value(s)), self->id)
				{
					idInt(sVar(block_tex), count)--;
					sVar(block_tex) = res;
				}
				
			}
			for (IntType s = IntType(0); s < ObjType(obj_history_save, save)->usage_block_tex_material_amount; s++)
			{
				withOne (Object, save_id_find(ObjType(obj_history_save, save)->usage_block_tex_material_save_id.Value(s)), self->id)
				{
					idInt(sVar(block_tex_material), count)--;
					sVar(block_tex_material) = res;
				}
				
			}
			for (IntType s = IntType(0); s < ObjType(obj_history_save, save)->usage_block_tex_normal_amount; s++)
			{
				withOne (Object, save_id_find(ObjType(obj_history_save, save)->usage_block_tex_normal_save_id.Value(s)), self->id)
				{
					idInt(sVar(block_tex_normal), count)--;
					sVar(block_tex_normal) = res;
				}
				
			}
			for (IntType s = IntType(0); s < ObjType(obj_history_save, save)->usage_scenery_amount; s++)
				withOne (Object, save_id_find(ObjType(obj_history_save, save)->usage_scenery_save_id.Value(s)), self->id)
					sVar(scenery) = res;
			
			for (IntType s = IntType(0); s < ObjType(obj_history_save, save)->usage_shape_tex_amount; s++)
				withOne (Object, save_id_find(ObjType(obj_history_save, save)->usage_shape_tex_save_id.Value(s)), self->id)
					sVar(shape_tex) = res;
			
			for (IntType s = IntType(0); s < ObjType(obj_history_save, save)->usage_shape_tex_material_amount; s++)
				withOne (Object, save_id_find(ObjType(obj_history_save, save)->usage_shape_tex_material_save_id.Value(s)), self->id)
					sVar(shape_tex_material) = res;
			
			for (IntType s = IntType(0); s < ObjType(obj_history_save, save)->usage_shape_tex_normal_amount; s++)
				withOne (Object, save_id_find(ObjType(obj_history_save, save)->usage_shape_tex_normal_save_id.Value(s)), self->id)
					sVar(shape_tex_normal) = res;
			
			for (IntType s = IntType(0); s < ObjType(obj_history_save, save)->usage_text_font_amount; s++)
			{
				withOne (Object, save_id_find(ObjType(obj_history_save, save)->usage_text_font_save_id.Value(s)), self->id)
				{
					idInt(sVar(text_font), count)--;
					sVar(text_font) = res;
				}
				
			}
			for (IntType s = IntType(0); s < ObjType(obj_history_save, save)->usage_sprite_tex_amount; s++)
				withOne (Object, save_id_find(ObjType(obj_history_save, save)->usage_sprite_tex_save_id.Value(s)), self->id)
					sVar(sprite_tex) = res;
			
			for (IntType s = IntType(0); s < ObjType(obj_history_save, save)->usage_sprite_template_tex_amount; s++)
				withOne (Object, save_id_find(ObjType(obj_history_save, save)->usage_sprite_template_tex_save_id.Value(s)), self->id)
					sVar(sprite_template_tex) = res;
			
			for (IntType s = IntType(0); s < ObjType(obj_history_save, save)->usage_kf_texture_amount; s++)
				withOne (Object, save_id_find(ObjType(obj_history_save, save)->usage_kf_texture_tl_save_id.Value(s)), self->id)
					ObjType(obj_keyframe, DsList(sInt(keyframe_list))[ObjType(obj_history_save, save)->usage_kf_texture_index.Value(s)])->value[e_value_TEXTURE_OBJ] = res;
			
			for (IntType s = IntType(0); s < ObjType(obj_history_save, save)->usage_kf_sound_amount; s++)
				withOne (Object, save_id_find(ObjType(obj_history_save, save)->usage_kf_sound_tl_save_id.Value(s)), self->id)
					ObjType(obj_keyframe, DsList(sInt(keyframe_list))[ObjType(obj_history_save, save)->usage_kf_sound_index.Value(s)])->value[e_value_SOUND_OBJ] = res;
			
			for (IntType s = IntType(0); s < ObjType(obj_history_save, save)->usage_kf_text_font_amount; s++)
				withOne (Object, save_id_find(ObjType(obj_history_save, save)->usage_kf_text_font_tl_save_id.Value(s)), self->id)
					ObjType(obj_keyframe, DsList(sInt(keyframe_list))[ObjType(obj_history_save, save)->usage_kf_text_font_index.Value(s)])->value[e_value_TEXT_FONT] = res;
			
			for (IntType s = IntType(0); s < ObjType(obj_history_save, save)->usage_tl_texture_amount; s++)
			{
				withOne (Object, save_id_find(ObjType(obj_history_save, save)->usage_tl_texture_save_id.Value(s)), self->id)
				{
					sVar(value)[e_value_TEXTURE_OBJ] = res;
					sBool(update_matrix) = true;
				}
				
			}
			for (IntType s = IntType(0); s < ObjType(obj_history_save, save)->usage_tl_sound_amount; s++)
			{
				withOne (Object, save_id_find(ObjType(obj_history_save, save)->usage_tl_sound_save_id.Value(s)), self->id)
				{
					sVar(value)[e_value_SOUND_OBJ] = res;
					sBool(update_matrix) = true;
				}
				
			}
			for (IntType s = IntType(0); s < ObjType(obj_history_save, save)->usage_tl_text_font_amount; s++)
			{
				withOne (Object, save_id_find(ObjType(obj_history_save, save)->usage_tl_text_font_save_id.Value(s)), self->id)
				{
					sVar(value)[e_value_TEXT_FONT] = res;
					sBool(update_matrix) = true;
				}
				
			}
			if (ObjType(obj_history_save, save)->usage_background_image)
				global::_app->background_image = res;
			if (ObjType(obj_history_save, save)->usage_background_sky_sun_tex)
			{
				idInt(global::_app->background_sky_sun_tex, count)--;
				global::_app->background_sky_sun_tex = res;
			}
			if (ObjType(obj_history_save, save)->usage_background_sky_moon_tex)
			{
				idInt(global::_app->background_sky_moon_tex, count)--;
				global::_app->background_sky_moon_tex = res;
			}
			if (ObjType(obj_history_save, save)->usage_background_sky_clouds_tex)
			{
				idInt(global::_app->background_sky_clouds_tex, count)--;
				global::_app->background_sky_clouds_tex = res;
			}
			if (ObjType(obj_history_save, save)->usage_background_ground_tex)
			{
				withOne (app, global::_app->id, self->id)
				{
					idInt(global::_app->background_ground_tex, count)--;
					global::_app->background_ground_tex = res;
					background_ground_update_texture(ScopeAny(self));
				}
				
			}
			if (ObjType(obj_history_save, save)->usage_background_ground_tex_material)
			{
				withOne (app, global::_app->id, self->id)
				{
					idInt(global::_app->background_ground_tex_material, count)--;
					global::_app->background_ground_tex_material = res;
					background_ground_update_texture_material(ScopeAny(self));
				}
				
			}
			if (ObjType(obj_history_save, save)->usage_background_ground_tex_normal)
			{
				withOne (app, global::_app->id, self->id)
				{
					idInt(global::_app->background_ground_tex_normal, count)--;
					global::_app->background_ground_tex_normal = res;
					background_ground_update_texture_normal(ScopeAny(self));
				}
				
			}
			self->count += ObjType(obj_history_save, save)->usage_model_amount;
			self->count += ObjType(obj_history_save, save)->usage_model_tex_amount;
			self->count += ObjType(obj_history_save, save)->usage_model_tex_material_amount;
			self->count += ObjType(obj_history_save, save)->usage_model_tex_normal_amount;
			self->count += ObjType(obj_history_save, save)->usage_item_tex_amount;
			self->count += ObjType(obj_history_save, save)->usage_block_tex_amount;
			self->count += ObjType(obj_history_save, save)->usage_block_tex_material_amount;
			self->count += ObjType(obj_history_save, save)->usage_block_tex_normal_amount;
			self->count += ObjType(obj_history_save, save)->usage_scenery_amount;
			self->count += ObjType(obj_history_save, save)->usage_shape_tex_amount;
			self->count += ObjType(obj_history_save, save)->usage_text_font_amount;
			self->count += ObjType(obj_history_save, save)->usage_sprite_tex_amount;
			self->count += ObjType(obj_history_save, save)->usage_sprite_template_tex_amount;
			self->count += ObjType(obj_history_save, save)->usage_kf_sound_amount;
			self->count += ObjType(obj_history_save, save)->usage_background_image;
			self->count += ObjType(obj_history_save, save)->usage_background_sky_sun_tex;
			self->count += ObjType(obj_history_save, save)->usage_background_sky_moon_tex;
			self->count += ObjType(obj_history_save, save)->usage_background_sky_clouds_tex;
			self->count += ObjType(obj_history_save, save)->usage_background_ground_tex;
		}
		
		sortlist_add(global::_app->res_list, res);
		return res;
	}
	
}
